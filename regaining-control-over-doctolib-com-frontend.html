<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="author" content="Romain Pellerin" />
        <meta name="keywords" content="romain pellerin, romain, pellerin, portfolio, site personnel, personal website, blog, code, javascript, frontend" />
        <meta name="geo.placename" content="San Francisco, California, USA" />
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="all" />
        <link rel="stylesheet" href="//romainpellerin.eu/theme/css/main.css" type="text/css" />
        <link rel="shortcut icon" href="//romainpellerin.eu/favicon.ico" />

        <script>
        function _dntEnabled(dnt, userAgent) {
            'use strict';

            // for old version of IE we need to use the msDoNotTrack property of navigator
            // on newer versions, and newer platforms, this is doNotTrack but, on the window object
            // Safari also exposes the property on the window object.
            var dntStatus = dnt || navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
            var ua = userAgent || navigator.userAgent;

            // List of Windows versions known to not implement DNT according to the standard.
            var anomalousWinVersions = ['Windows NT 6.1', 'Windows NT 6.2', 'Windows NT 6.3'];

            var fxMatch = ua.match(/Firefox\/(\d+)/);
            var ieRegEx = /MSIE|Trident/i;
            var isIE = ieRegEx.test(ua);
            // Matches from Windows up to the first occurance of ; un-greedily
            // http://www.regexr.com/3c2el
            var platform = ua.match(/Windows.+?(?=;)/g);

            // With old versions of IE, DNT did not exist so we simply return false;
            if (isIE && typeof Array.prototype.indexOf !== 'function') {
                return false;
            } else if (fxMatch && parseInt(fxMatch[1], 10) < 32) {
                // Can't say for sure if it is 1 or 0, due to Fx bug 887703
                dntStatus = 'Unspecified';
            } else if (isIE && platform && anomalousWinVersions.indexOf(platform.toString()) !== -1) {
                // default is on, which does not honor the specification
                dntStatus = 'Unspecified';
            } else {
                // sets dntStatus to Disabled or Enabled based on the value returned by the browser.
                // If dntStatus is undefined, it will be set to Unspecified
                dntStatus = { '0': 'Disabled', '1': 'Enabled' }[dntStatus] || 'Unspecified';
            }
            return dntStatus === 'Enabled' ? true : false;
        }
        if (!_dntEnabled()) {
            // If user has enabed Do Not Track, Google Analytics is not loaded.
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

            ga('create', 'UA-39228475-3', 'auto');
            ga('send', 'pageview');
        }
        </script>

        <!-- Social media -->
        <meta name="twitter:card" content="summary" />
        <meta name="twitter:site" content="@romainpellerin" />
        <meta name="description" content="Doctolib has been growing rapidly over the past 5 years, as has our code base. We have been able to deliver numerous features in a timely manner, but oftentimes at the expense of code legibility and…" />
        <meta property="og:image" name="twitter:image" content="//romainpellerin.eu/theme/img/romain_pellerin-1x.jpg" />
        <meta property="og:title" name="twitter:title" content="Regaining control over Doctolib.com frontend - Romain Pellerin's Blog" />
        <meta property="og:description" name="twitter:description" content="Doctolib has been growing rapidly over the past 5 years, as has our code base. We have been able to deliver numerous features in a timely manner, but oftentimes at the expense of code legibility and…" />

        <title>Regaining control over Doctolib.com frontend - Romain Pellerin's Blog</title>

        <link href="//romainpellerin.eu/feeds/atom.xml" type="application/atom+xml" rel="alternate" title="Romain Pellerin's Blog Atom Feed" />
        <link href="//romainpellerin.eu/feeds/rss.xml" type="application/rss+xml" rel="alternate" title="Romain Pellerin's Blog RSS Feed" />
    </head>
    <body>
        <div id="wrapper">

<nav class="flexbox-row">
    <a class="center" href="//romainpellerin.eu/">Homepage</a>
    <span class="center">|| Blog:</span>
    <a class="center" href="//romainpellerin.eu/archives.html">Archives (all posts)</a>
    <a class="center" href="//romainpellerin.eu/categories.html">Categories</a>
    <a class="center" href="//romainpellerin.eu/tags.html">Tags</a>
    <a class="center" href="//romainpellerin.eu/feeds/rss.xml">RSS feed</a>
    <a class="center" href="//romainpellerin.eu/feeds/atom.xml">Atom feed</a>
</nav><header class="article-header center">
    <img src="images/regaining-control-over-doctolib-com-frontend/header.jpeg" alt="Header picture" id="header-picture" />
    <p id="back-line" class="small grey"><span>
<time datetime="2019-05-14T14:30:00+02:00">Tue 14 May 2019</time>        </p>
    <h1>Regaining control over Doctolib.com frontend</h1>
    <div class="grey">
        <p class="italic">Doctolib has been growing rapidly over the past 5 years, as has our code base. We have been able to deliver numerous features in a timely manner, but oftentimes at the expense of code legibility and…</p>
        <p class="small">
            &#128338; <span title="Based on a 200 words per minute reading speed. This article has a total of 1807 words.">9 min read</span>
        </p>
<p class="small">Category: <a title="Go to the category" href="//romainpellerin.eu/category/code.html">Code</a></p><p class="small">Tags: <a title="Go to the tag" href="//romainpellerin.eu/tag/code.html">code</a>, <a title="Go to the tag" href="//romainpellerin.eu/tag/javascript.html">javascript</a>, <a title="Go to the tag" href="//romainpellerin.eu/tag/frontend.html">frontend</a></p>    </div>
</header>
<article>
    <p><em>Originally published on <a href="https://medium.com/@romain.pellerin/regaining-control-over-doctolib-com-frontend-9ec8cc41037f">Medium</a>.</em></p>
<p>Doctolib has been growing rapidly over the past 5 years, as has our code base. We have been able to deliver numerous features in a timely manner, but oftentimes at the expense of code legibility and simplicity. The year 2018 was for us an opportunity to step back, learn from our mistakes, and set goals in order for us to regain control over our frontend. Specifically, we re-defined <a href="https://medium.com/doctolib/treating-technical-debt-62630ee64ef7">technical debt and legacy code</a> and took measures to reduce it so that we could keep growing at an ever-faster rate and continue to ship features that practitioners and patients love.</p>
<h1>Identifying pain points</h1>
<p>Twice a year a team of people with a strong interest in JavaScript gather to discuss frontend at Doctolib. One person from each feature team is selected to join the meetings. Nevertheless, the meetings are also open to anyone, as long as they express an interest and have proved themselves to be proficient in JavaScript.</p>
<p>In advance of these meetings, we circulate email surveys to all of the software engineers to identify their specific issues and struggles. Below is an extract from the latest survey we sent out in November 2018:</p>
<blockquote>
<ul>
<li>What is your biggest pain point on the frontend stack?</li>
<li>What elements are holding you back? What prevents you from being more effective?</li>
<li>Is there anything you don’t understand/you don’t master? RxJS, recompact, react-form? React context, HOC, …?</li>
<li>Is the directory structure good enough? Does it make sense?</li>
<li>Any tool-related problems? (Prettier, IDE, Chrome DevTools)</li>
<li>Apart from <code>console.log</code>, how do you debug?</li>
<li>Do you know Jest? Do you know how to write JavaScript unit tests?</li>
<li>Do you know what React components we have? Do you know how to use them and what props they expect?</li>
</ul>
</blockquote>
<p>These simple, short questionnaires allow us to gather valuable feedback from all of the engineers. Using them, we are able to identify the most-cited problems and define what legacy means at Doctolib during our bi-annual meetings.</p>
<p>After analyzing the results of these surveys, we usually come up with a new direction and a list of tasks for the following two quarters. These actions are then shared with the rest of the engineers during an all-hands meeting with the entire tech team.</p>
<h1>What is legacy code at Doctolib in 2018?</h1>
<h2>RxJS</h2>
<p>When Doctolib was in its early stages, state management for React apps was still very experimental and there was no consensus about which way to go. Two emerging libraries were becoming fashionable: Redux and RxJS. The decision was made to pick RxJS, but it could have just as well been Redux.</p>
<p>Over time, RxJS usage grew and the library was soon imported into every file and used for just about anything and everything: app state management, tiny component states, forms, buttons, AJAX requests, etc.</p>
<p><strong>Why is this legacy now?</strong> Well, first of all, RxJS is not entirely legacy but the way it’s being used at Doctolib is. This is mostly because it has been used for everything, although <a href="https://xgrommx.github.io/rx-book/content/guidelines/when/index.html">its use cases are normally meant to be very specific and restricted</a>. RxJS also makes unit testing difficult because Observables need to be mocked-up. <a href="https://xgrommx.github.io/rx-book/content/guidelines/when/index.html">Reactive programming is not known by many</a>, as indicated on the graph below, therefore it does not help shorten new joiners’ ramp-up time — quite the opposite, to be honest. Our aim is to restrain its use cases to what it was originally intended to be used for: event-based computations and asynchronous sequences of data.</p>
<figure class="center">
<img src="//romainpellerin.eu/images/regaining-control-over-doctolib-com-frontend/rxjs-graph.png" alt="Graph showing RxJS popularity" />
<figcaption>RxJS ranks last among the “other” JavaScript libraries in 2018 <a target="_blank" href="https://2018.stateofjs.com/front-end-frameworks/other-libraries/">[Source]</a>.</figcaption>
</figure>

<h2>Recompose/Recompact</h2>
<p>At the same time as RxJS was released, another helper library came out: <a href="https://github.com/acdlite/recompose">recompose</a>. As recompose was not meeting all of our needs, the project was forked, patched, and renamed as <a href="https://github.com/neoziro/recompact">recompact</a>. Once again, it quickly spread across the code base, bringing Higher Order Components everywhere, as well as additional complexity for new joiners.</p>
<p><strong>Why is this legacy now?</strong> Most helpers from recompact can be written in vanilla React (recompact.pure or recompact.withProps to name a few). Given that early advocates of recompact at Doctolib left the company a while ago, it became challenging to pass down knowledge and help new joiners get up to speed quickly. Moreover, the original library (recompose) was recently officially <a href="https://github.com/acdlite/recompose#a-note-from-the-author-acdlite-oct-25-2018">deprecated</a> because of an upcoming React feature, <a href="https://reactjs.org/docs/hooks-intro.html">Hooks</a>, not forgetting that recompose/recompact rely on the legacy React Context API. We now aim at getting rid of recompact altogether.</p>
<h2>jQuery and CoffeeScript</h2>
<p>Since the very beginning, jQuery and CoffeeScript have been lying around in the code base. jQuery helped features come to life in no time, bridging the gap between various browsers, oftentimes with poor support for new Web APIs. As for CoffeeScript, it is tightly coupled with Ruby on Rails, our backend, thus it has been there from the beginning.</p>
<p><strong>Why is this legacy now?</strong> Starting this year, we only support modern browsers and Internet Explorer 11. Consequently, it does not make any sense to use jQuery when we can write plain JavaScript; and CoffeeScript adds unneeded complexity given that very few people can understand it at a glance, let alone write it.</p>
<h2>React unsafe life-cycle methods</h2>
<p>Last but not least, we recently deprecated a few React life-cycle methods and helpers, following the maintainers’ advice about unsafe methods. <a href="https://reactjs.org/docs/strict-mode.html">React.StrictMode was recently introduced</a> as a tool to help detect potential issues within an app. We cautiously started adding it in the codebase, to avoid having too many warnings popping up here and there while developing. Here is the list of life-cycle methods or helpers we decided to deprecate early in our codebase: <em>componentWillMount</em>, <em>componentWillReceiveProps</em>, <em>componentWillUpdate</em> and <em>findDOMNode</em>.</p>
<h1>Tackling and killing legacy</h1>
<p>After agreeing upon what can be defined as legacy, the time comes to actually kill it. The way frontend legacy is handled at Doctolib is always the same; we pretty much stick to <a href="https://medium.com/@addyosmani/measure-optimize-monitor-33e36108e014">MOM</a>: <em>Measure, Optimize and Monitor</em>.</p>
<p><strong><em>Measuring</em></strong> is done by way of our survey and our own experience while developing. While evaluating the relevance of each pain point collected, we prioritize them according to the number of times they are mentioned. We also assess the feasibility over the short-term: short and easy tasks tend to move up on the list of actions. Finally, these actions become Tech Tasks.</p>
<p><strong><em>Optimizing</em></strong> is done progressively, after our bi-annual meetings, through special tasks we call <strong>Tech Tasks</strong>. These tasks are differentiated from regular feature tasks by their very own nature: they are purely technical tasks whose goal is to improve platform stability, security, and performance as well as to reduce technical debt. People usually pick the ones they like best when they work on Tech Tasks (Fridays are Tech Tasks days for most feature teams). However, a few big and/or complex tasks do get assigned during our bi-annual meeting in order to make sure that they will eventually be carried out. These big tasks are prioritized by the solution architects and engineering managers on a regular basis to ensure they fit into the roadmap.</p>
<p>Finally, <strong><em>monitoring</em></strong> is done throughout. It is a never-ending process. At the end of every meeting, we set KPIs to “track” and then we immediately create dashboards to track usage of “legacy” through these KPIs. One person is in charge of creating these graphs, usually the same person who called a meeting in the first place. Basically, this translates to metrics we expect to drop.</p>
<figure class="center">
<img src="//romainpellerin.eu/images/regaining-control-over-doctolib-com-frontend/recompact.png" alt="Recompact monitoring graphs" />
<figcaption>3 out of the many graphs we use to monitor recompact usage</figcaption>
</figure>

<p>These three graphs above show the number of lines in our code base containing a deprecated function. This is how we compute these numbers:</p>
<script src="https://gist.github.com/rpellerin/6488f5f4bf893a8555a3261ddf2d0856.js"></script>

<p>We also create less-specific dashboards which list the “general” legacy functions and libraries we aim at reducing or killing altogether.</p>
<figure class="center">
<img src="//romainpellerin.eu/images/regaining-control-over-doctolib-com-frontend/general-legacy.png" alt="Other monitoring graphs" />
<figcaption>Everything that is considered legacy is shown on this graph</figcaption>
</figure>

<p>These graphs are a helpful starting point from which we can monitor progress.</p>
<h2>Preventing people from using it</h2>
<p>There is a long-lasting tradition of heavily relying on static checks at Doctolib. Essentially, they are script files which we run on source code as it is — before transpilation and bundling. Our CI pipeline runs these tests first, before running any of our 8000+ end-to-end tests. Below is the one test which checks for new lines containing deprecated React methods and recompact helpers, and then reports on Pull Requests.</p>
<script src="https://gist.github.com/rpellerin/2521a2dd9e9a0c6cd993755441fffcea.js"></script>

<p>In addition to relying on static checks, we also regularly inform and remind people about our best practices on the frontend stack. We usually demo state-of-the-art JavaScript once a month, during what we call “Tech Time” — a meeting for and by software engineers. It’s also a good opportunity to show how much progress is being made on reducing legacy code.</p>
<h2>Meeting objectives</h2>
<p>Oftentimes, the long tasks tend to remain “<em>in progress</em>” forever and people lose interest in them. This is when the people who first defined these objectives come into play. It is their responsibility to help these tasks reach a conclusion by supporting those working on it and providing a helping hand if need be.</p>
<p>In any case, every bi-annual meeting starts off with a review of what has been achieved during the previous term and carries on from there.</p>
<h1>Long-term vision</h1>
<p>Deprecating these few React functions, recompact, a significant part of our RxJS usage, jQuery, and CoffeeScript is a major first step. By doing so we can ease new joiners’ onboarding, keep up with the latest JavaScript standards, and reduce our technical debt. It also belongs to a bigger picture. Creating these dashboards opens the door to more monitoring, which ultimately means more control. A recent concrete example is the bundle size dashboard, which we introduced a few weeks ago.</p>
<figure class="center">
<img src="//romainpellerin.eu/images/regaining-control-over-doctolib-com-frontend/bundle-sizes.png" alt="Bundle sizes graphs" />
<figcaption>This dashboards tracks our bundles sizes over time</figcaption>
</figure>

<p>Not only does it store the sizes over time but it also reports on Github Pull Requests. <a href="https://www.npmjs.com/package/bundlesize">A handy npm package called bundlesize</a> checks that every build does not exceed thresholds defined in our package.json file.</p>
<figure class="center">
<img src="//romainpellerin.eu/images/regaining-control-over-doctolib-com-frontend/github-pr-checks.png" alt="Checks on Github pull requests" />
<figcaption>Checks on a Github Pull Request</figcaption>
</figure>

<p>In addition to more monitoring, we’ll keep collecting feedback on a regular basis from all of the software engineers, calling for more meetings when needed. We will specifically be paying attention to new joiners, how they feel about the frontend stack and how we can make their onboarding even easier. We don’t want to be held back by legacy code. Instead, we want to be able to experiment with new technologies when relevant, adopt the latest JavaScript standards, and keep up with React.</p>
<p>There is still much to do on the frontend. A Single-Page-Application is much more than just a website. It’s software that runs in a browser. Hundreds of different browser versions actually, operating at various speeds, with unreliable network connectivity. It has to be as good as any software program. The time when servers were the unique focus point has come and gone; frontend requires a different kind of attention, not less.</p>
<p><em>Originally published on <a href="https://medium.com/@romain.pellerin/regaining-control-over-doctolib-com-frontend-9ec8cc41037f">Medium</a>.</em></p>
</article>
<footer class="grey italic small">
    Last update: Tue 14 May 2019</footer>

        </div> <!-- WRAPPER -->
    </body>
</html>