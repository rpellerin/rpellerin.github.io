<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="author" content="Romain Pellerin" />
        <meta name="keywords" content="romain pellerin, romain, pellerin, portfolio, site personnel, personal website, blog, raspberry pi, linux, talk" />
        <meta name="geo.placename" content="San Francisco, California, USA" />
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="all" />
        <link rel="stylesheet" href="//romainpellerin.eu/theme/css/main.css" type="text/css" />
        <link rel="shortcut icon" href="//romainpellerin.eu/favicon.ico" />

        <script>
        function _dntEnabled(dnt, userAgent) {
            'use strict';

            // for old version of IE we need to use the msDoNotTrack property of navigator
            // on newer versions, and newer platforms, this is doNotTrack but, on the window object
            // Safari also exposes the property on the window object.
            var dntStatus = dnt || navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
            var ua = userAgent || navigator.userAgent;

            // List of Windows versions known to not implement DNT according to the standard.
            var anomalousWinVersions = ['Windows NT 6.1', 'Windows NT 6.2', 'Windows NT 6.3'];

            var fxMatch = ua.match(/Firefox\/(\d+)/);
            var ieRegEx = /MSIE|Trident/i;
            var isIE = ieRegEx.test(ua);
            // Matches from Windows up to the first occurance of ; un-greedily
            // http://www.regexr.com/3c2el
            var platform = ua.match(/Windows.+?(?=;)/g);

            // With old versions of IE, DNT did not exist so we simply return false;
            if (isIE && typeof Array.prototype.indexOf !== 'function') {
                return false;
            } else if (fxMatch && parseInt(fxMatch[1], 10) < 32) {
                // Can't say for sure if it is 1 or 0, due to Fx bug 887703
                dntStatus = 'Unspecified';
            } else if (isIE && platform && anomalousWinVersions.indexOf(platform.toString()) !== -1) {
                // default is on, which does not honor the specification
                dntStatus = 'Unspecified';
            } else {
                // sets dntStatus to Disabled or Enabled based on the value returned by the browser.
                // If dntStatus is undefined, it will be set to Unspecified
                dntStatus = { '0': 'Disabled', '1': 'Enabled' }[dntStatus] || 'Unspecified';
            }
            return dntStatus === 'Enabled' ? true : false;
        }
        if (!_dntEnabled()) {
            // If user has enabed Do Not Track, Google Analytics is not loaded.
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

            ga('create', 'UA-39228475-3', 'auto');
            ga('send', 'pageview');
        }
        </script>

        <!-- Social media -->
        <meta name="twitter:card" content="summary" />
        <meta name="twitter:site" content="@romainpellerin" />
        <meta name="description" content="A complete tutorial about how to create a home server using a Raspberry Pi" />
        <meta property="og:image" name="twitter:image" content="//romainpellerin.eu/theme/img/romain_pellerin-1x.jpg" />
        <meta property="og:title" name="twitter:title" content="Raspberry Pi: The Ultimate Guide - Romain Pellerin's Blog" />
        <meta property="og:description" name="twitter:description" content="A complete tutorial about how to create a home server using a Raspberry Pi" />

        <title>Raspberry Pi: The Ultimate Guide - Romain Pellerin's Blog</title>

        <link href="//romainpellerin.eu/feeds/atom.xml" type="application/atom+xml" rel="alternate" title="Romain Pellerin's Blog Atom Feed" />
        <link href="//romainpellerin.eu/feeds/rss.xml" type="application/rss+xml" rel="alternate" title="Romain Pellerin's Blog RSS Feed" />
    </head>
    <body>
        <div id="wrapper">

<nav class="flexbox-row">
    <a class="center" href="//romainpellerin.eu/">Homepage</a>
    <span class="center">|| Blog:</span>
    <a class="center" href="//romainpellerin.eu/archives.html">Archives (all posts)</a>
    <a class="center" href="//romainpellerin.eu/categories.html">Categories</a>
    <a class="center" href="//romainpellerin.eu/tags.html">Tags</a>
    <a class="center" href="//romainpellerin.eu/feeds/rss.xml">RSS feed</a>
    <a class="center" href="//romainpellerin.eu/feeds/atom.xml">Atom feed</a>
</nav><header class="article-header center">
    <p id="back-line" class="small grey"><span>
<time datetime="2016-07-10T05:11:00+02:00">Sun 10 July 2016</time> - Last Update: <time datetime="2021-01-01T19:00:00+01:00">Fri 01 January 2021</time>        </p>
    <h1>Raspberry Pi: The Ultimate Guide</h1>
    <div class="grey">
        <p class="italic">A complete tutorial about how to create a home server using a Raspberry Pi</p>
        <p class="small">
            &#128338; <span title="Based on a 200 words per minute reading speed. This article has a total of 5832 words.">29 min read</span>
        </p>
<p class="small">Category: <a title="Go to the category" href="//romainpellerin.eu/category/linux.html">Linux</a></p><p class="small">Tags: <a title="Go to the tag" href="//romainpellerin.eu/tag/raspberry-pi.html">raspberry pi</a>, <a title="Go to the tag" href="//romainpellerin.eu/tag/linux.html">linux</a>, <a title="Go to the tag" href="//romainpellerin.eu/tag/talk.html">talk</a></p>    </div>
</header>
<article>
    <p><em><a href="//romainpellerin.eu/extra/raspberry-pi-as-a-home-server-PDF.zip">Here is an old document I created a while ago. I keep it here for legacy purposes.</a></em></p>
<p>I'll keep this article as short as possible (no explanation where things are self-explanatory or obvious), mainly due to the fact that the article will be quite lengthy. I'll give instructions about how to setup a Raspberry Pi as well as how to install stuff. This blog post might change in a near future.</p>
<h1 id="goal">Goal</h1>
<p>I decided to built a cheap home server to host websites, have a VPN server hosted in France, have a Nextcloud instance, and so forth. A Raspberry Pi, which costs less than $5 a year (electricity consumption) was the perfect solution. As I'm not that often in France, I needed to be able to operate it remotely. I also wanted plenty of storage, a SD card would not be sufficient. I had to plug a hard disk drive. Furthermore, I wanted it to be encrypted, just in case a malicious person tries to read my hard disk drive.</p>
<p>To sum up, few requirements, but big advantages. Let's get started!</p>
<h1 id="what-i-used-for-this-tutorial">What I used for this tutorial</h1>
<ul>
<li><a href="https://www.raspberrypi.org/products/raspberry-pi-3-model-b/">A Raspberry Pi v3 model B</a></li>
<li>A hard disk drive (<a href="http://wdlabs.wd.com/products/wd-pidrive-314gb/">WD's PiDrive</a>)</li>
<li>Cables (<a href="http://wdlabs.wd.com/products/raspberry-pi-accessories/">WD's PiDrive Cable Kit</a> and an Ethernet cable)</li>
<li>A micro SD card (<a href="http://www.samsung.com/us/computer/memory-storage/MB-MP16DA/AM">Samsung's microSDHC 16GB EVO Memory Card with Adapter</a>)</li>
<li>A TV with a HDMI cable</li>
<li>A laptop with a card reader running GNU/Linux (Xubuntu to be precise)</li>
<li>A wired keyboard</li>
<li>A regular DSL Internet connection</li>
</ul>
<h1 id="setting-up-the-raspberry-pi">Setting up the Raspberry Pi</h1>
<h2 id="the-os">The OS</h2>
<ol>
<li>Download Raspbian Lite from <a href="https://www.raspberrypi.org/downloads/raspbian/">the official website</a>. It might be a good idea to verify the hash (SHA1). <strong>Consider downloading the 64-bit version of the OS.</strong>. It adds supports for files larger than 4GB and also it fixes the issue with Nextcloud when the trashbin exceeds 4GB in size and can't be accessed anymore.</li>
<li>Extract the file .img from the zip.</li>
<li>
<p>Run one of the following commands:</p>
<div class="highlight"><pre><span></span><code>df
lsblk
blkid
fdisk -l
</code></pre></div>

</li>
<li>
<p>Plug in the SD card (on a regular computer, not the Raspberry Pi)</p>
</li>
<li>Redo step 3. in order to identify the SD card. <code>/dev/mmcblk0</code> or <code>/dev/sdb</code> for instance. <code>/dev/mmcblk0pX</code> or <code>/dev/sdbX</code> would be a partition on the device, with X an integer.</li>
<li>
<p>Unmount <strong>all</strong> the partitions and copy Raspbian on the whole SD card:</p>
<div class="highlight"><pre><span></span><code>umount /dev/mmcblk0p1
sudo dd <span class="nv">bs</span><span class="o">=</span>1M <span class="k">if</span><span class="o">=</span><span class="m">2014</span>-09-09-wheezy-raspbian.img <span class="nv">of</span><span class="o">=</span>/dev/mmcblk0 <span class="nv">status</span><span class="o">=</span>progress <span class="nv">conv</span><span class="o">=</span>fsync
sudo sync <span class="o">&amp;&amp;</span> sync
</code></pre></div>

<p><code>bs=4M</code> can be used but it's more error prone, yet it's safer. There won't be any feedback during <code>dd</code> so wait till it finishes (might be long).</p>
</li>
<li>
<p>You're done. For more information, see the <a href="http://www.raspberrypi.org/documentation/installation/installing-images/linux.md">official website</a>. Now <a href="https://www.raspberrypi.org/blog/a-security-update-for-raspbian-pixel/">enable SSH</a> by creating an empty file named <code>ssh</code> in <code>/boot</code>. Add a default user with <code>echo "pi:$(echo 'raspberry' | openssl passwd -6 -stdin)" &gt; /boot/userconf.txt</code>. Then, unmount the SD card and eject it.</p>
</li>
</ol>
<h2 id="first-boot">First boot</h2>
<ol>
<li>Insert the micro SD card in the Raspberry Pi. Plug in an Ethernet wire or make sure you have a Wifi access point available on which you can connect, Plug in the HDMI cable (connected to a screen), a keyboard and eventually the power cable.</li>
<li>
<p>Log in (user name is <em>pi</em> and password is <em>raspberry</em>). You can do it using a keyboard or over SSH if you Raspberry is connected. Then set the locales and the right keyboard layout:</p>
<div class="highlight"><pre><span></span><code>sudo su
dpkg-reconfigure locales <span class="c1"># Select with space bar, at least en_US.UTF-8 and fr_FR.UTF-8 plus any other you need</span>
dpkg-reconfigure keyboard-configuration <span class="c1"># A keyboard must be plugged in</span>
dpkg-reconfigure tzdata
</code></pre></div>

<p>Regarding the keyboard layout, there are <a href="http://raspberrypi.stackexchange.com/questions/10060/raspbian-keyboard-layout/10103#10103">other alternatives</a>. Then reboot (<code>sudo reboot</code>).</p>
</li>
</ol>
<h2 id="configuration">Configuration</h2>
<ol>
<li>
<p>Should you need to connect over Wifi, here's how to do it:</p>
<div class="highlight"><pre><span></span><code>sudo iwlist wlan0 scan
sudo nano /etc/wpa_supplicant/wpa_supplicant.conf
</code></pre></div>

<p>Go to the bottom of the file and add the following:</p>
<div class="highlight"><pre><span></span><code>network={
    ssid=&quot;The_ESSID_from_earlier&quot;
    psk=&quot;Your_wifi_password&quot;
}
</code></pre></div>

<p>Otherwise, disable Wifi (and Bluetooth) as it draws power. One solution (preferred) is to list all blockable devices (<code>rfkill list all</code>) and then block bluetooth (<code>sudo rfkill block 1</code> (<code>0</code> is usually for Wi-Fi)). The other solution is to create <code>/etc/modprobe.d/disable_rpi3_wifi_bt.conf</code> and add the following:</p>
<div class="highlight"><pre><span></span><code>##wifi
blacklist brcmfmac
blacklist brcmutil
##bt
blacklist btbcm
blacklist hci_uart
</code></pre></div>

<p>Save and reboot. <a href="https://www.raspberrypi.org/documentation/configuration/wireless/wireless-cli.md">More information</a>. At next reboot, make sure you're either connected or that Wifi is disabled by typing <code>ip a</code>.</p>
</li>
<li>
<p>Double the current limit if your intend to plug USB devices. In <code>/boot/config.txt</code>, add the following:</p>
<div class="highlight"><pre><span></span><code>max_usb_current=1
</code></pre></div>

<p><a href="https://www.raspberrypi.org/forums/viewtopic.php?p=930695#p930695">Some people say this has no effect on Raspberry Pi 3</a>.<br>
You may finish editing this file by fine-tuning its parameters.</p>
</li>
<li>
<p>Update you Pi:</p>
<div class="highlight"><pre><span></span><code>sudo apt update
sudo apt upgrade
sudo apt install vim
<span class="c1"># sudo apt install rpi-update # if this packet is missing</span>
<span class="c1"># sudo reboot</span>
<span class="c1"># sudo rpi-update # gets the latest firmware, normal users should not have to do it</span>
<span class="c1"># More info, read: https://github.com/Hexxeh/rpi-update#notes</span>
<span class="c1"># sudo reboot</span>
<span class="c1"># sudo apt update</span>
<span class="c1"># sudo apt upgrade</span>
</code></pre></div>

</li>
<li>
<p>For security concerns, let's create a new user. The <em>pi</em> user will be deleted later.</p>
<div class="highlight"><pre><span></span><code>sudo su
passwd <span class="c1"># Add a password to the root account</span>
adduser pipi
usermod -a -G video pipi <span class="c1"># Otherwise omxplayer won&#39;t work with this user</span>
<span class="nb">echo</span> <span class="s1">&#39;export HISTSIZE=100000&#39;</span> &gt;&gt; /root/.bashrc
<span class="nb">echo</span> <span class="s1">&#39;export HISTFILESIZE=100000&#39;</span> &gt;&gt; /root/.bashrc
<span class="nb">echo</span> <span class="s1">&#39;export EDITOR=vim&#39;</span> &gt;&gt; /root/.bashrc
<span class="nb">exit</span>
<span class="c1"># Stay connected as &#39;pi&#39; for now</span>
</code></pre></div>

</li>
<li>
<p>Config the Pi:</p>
<div class="highlight"><pre><span></span><code>sudo raspi-config
</code></pre></div>

<p>You should not expand the filesystem, neither change the user password cause we'll delete the <em>pi</em> user anyway. However, you should change the system options (wait for network at boot). You might change the internationalisation options to English (UTF-8), but it's the same as running <code>dpkg-reconfigure locales</code>. If you want to change the timezone and keyboard layout, plug in a keyboard on the Pi and do it from that keyboard. Change overscan if you see black bars. Change the hostname if you want. Finally, adjust memory split (128MB is sufficient for 1080p videos). Then, reboot. And log in back using the <em>pi</em> user.</p>
</li>
<li>
<p>You should probably remove the ability to run "root" commands without typing pi’s password.</p>
<div class="highlight"><pre><span></span><code>sudo visudo <span class="c1"># it will safely edit /etc/sudoers</span>
</code></pre></div>

<p>Here, remove "NOPASSWD: ". If there is no such a line, check out the file <code>/etc/sudoers.d/010_pi-nopasswd</code> and delete it.</p>
</li>
<li>
<p>From another computer (not your Pi), do this:</p>
<div class="highlight"><pre><span></span><code>ssh-keygen <span class="c1"># Use default choices</span>
ssh-copy-id -i <span class="nv">$HOME</span>/.ssh/id_rsa.pub pipi@&lt;raspberry-pi-IP&gt;
</code></pre></div>

</li>
<li>
<p>Get back to your Pi, still logged in as <em>pi</em> and do:</p>
<div class="highlight"><pre><span></span><code>su
apt install rsync
<span class="c1"># rsync is just better than cp, we&#39;ll need it later</span>
</code></pre></div>

</li>
<li>
<p>Now, it's time to delete the <em>pi</em> user. Log in as your new user (in my case it's <em>pipi</em>) and then:</p>
<div class="highlight"><pre><span></span><code>su <span class="c1"># Type the root password here</span>
deluser --remove-home pi
visudo <span class="c1"># Make sure there&#39;s no reference to pi user</span>
</code></pre></div>

</li>
</ol>
<h2 id="moving-root-onto-an-external-hard-disk-drive-not-encrypted-with-additional-encrypted-data-partition">Moving <code>/root</code> onto an external hard disk drive, not encrypted, with additional encrypted DATA partition</h2>
<p><strong>NOTE THAT RECENT RASPBERRY PIS CAN BOOT DIRECTLY FROM A USB MASS STORAGE DEVICE, WITH NO SD INSERTED</strong>: <a href="https://www.raspberrypi.org/documentation/hardware/raspberrypi/bootmodes/msd.md">tutorial here</a>.</p>
<p><em>Right after this section you will find another one about how to do a similar operation using an encrypted hard disk.</em></p>
<p>As root,</p>
<div class="highlight"><pre><span></span><code>lsblk <span class="c1"># Identify the hard disk drive connected to the Pi</span>
fdisk /dev/sda
</code></pre></div>

<p>Do the following sequence of keystrokes:</p>
<div class="highlight"><pre><span></span><code>d # Delete all the existing partitions if many
n # Create a new one
p # Primary
1
&lt;Enter&gt; # Hit enter key
+100G # 100GB, or something else
# This partition should be of type Linux (83)
n # Create a second partition, swap
p
2
&lt;Enter&gt;
+2G
t # Change the type...
2 # Of the second partion
82 # Make it a swap partition
n # Create the data partition
p
3
&lt;Enter&gt;
&lt;Enter&gt;
p # Make sure everything is OK and press w
w
</code></pre></div>

<p>Then:</p>
<div class="highlight"><pre><span></span><code>mkfs.ext4 /dev/sda1 -L ROOT -m <span class="m">5</span>
mkswap /dev/sda2
mkfs.ext4 /dev/sda3 -L DATA -m <span class="m">5</span> <span class="c1"># I think this step is not necessary but did not check...</span>
apt install cryptsetup
cryptsetup --verify-passphrase -c aes-xts-plain64 -s <span class="m">512</span> -h sha256 luksFormat /dev/sda3
cryptsetup -v luksOpen /dev/sda3 hddcrypt
mkfs.ext4 /dev/mapper/hddcrypt -L DATA -m <span class="m">1</span>
mkdir /mnt/data_partition
mount /dev/mapper/hddcrypt /mnt/data_partition/

cat /boot/cmdline.txt <span class="c1"># See if you can find root=/dev/mmcblk0p2. If yes then...</span>
sed -e <span class="s2">&quot;s|root=/dev/mmcblk0p2|root=/dev/sda1|&quot;</span> -i /boot/cmdline.txt
<span class="c1"># Otherwise, manually replace root=PARTUUID=123 with the right PARTUUID found in `blkid`</span>
<span class="c1"># Add &#39;bootwait&#39; at the end of the line, in the same file, separated from the rest by a space char</span>
<span class="c1"># The &#39;rootwait&#39; option forces the kernel to wait until the root device becomes ready</span>
</code></pre></div>

<p>Edit <code>/etc/fstab</code> that way:</p>
<div class="highlight"><pre><span></span><code>proc            /proc           proc    defaults          0       0
PARTUUID=123    /boot           vfat    defaults          0       2
PARTUUID=456    /               ext4    defaults,noatime  0       1
PARTUUID=789    none            swap    sw                0       0
</code></pre></div>

<p>Then:</p>
<div class="highlight"><pre><span></span><code>mkdir /tmp/rootsd <span class="o">&amp;&amp;</span> mount /dev/mmcblk0p2 /tmp/rootsd
mkdir /tmp/roothdd <span class="o">&amp;&amp;</span> mount /dev/sda1 /tmp/roothdd
rsync -a /tmp/rootsd/ /tmp/roothdd/
sync
e2fsck -f /dev/sda1 <span class="c1"># You might need to umount it first (umount /tmp/roothdd)</span>
reboot
su
update-rc.d -f dphys-swapfile remove
apt remove dphys-swapfile
cat /proc/swaps
swapoff /var/swap <span class="c1"># Might fail if it was not listed in the previous command</span>
rm -f /var/swap
reboot
su
/sbin/swapon -s <span class="c1"># Make sure only your swap partition is in use</span>
dd <span class="k">if</span><span class="o">=</span>/dev/urandom <span class="nv">of</span><span class="o">=</span>/dev/mmcblk0p2 <span class="nv">bs</span><span class="o">=</span>10M <span class="c1"># Overwrite data of unused old root partition</span>
fdisk /dev/mmcblk0 <span class="c1"># Delete second partition</span>
</code></pre></div>

<h2 id="moving-root-onto-an-external-hard-disk-drive-encrypted">Moving <code>/root</code> onto an external hard disk drive, encrypted</h2>
<p>I would like to thank a few websites which helped me a lot to write this article:</p>
<ul>
<li><a href="http://paxswill.com/blog/2013/11/04/encrypted-raspberry-pi/">Using an Encrypted Root Partition with Raspbian</a></li>
<li><a href="http://chezmanu.eu/RPI-Chiffrement.php">Chiffrement d'un Raspberry Pi avec Raspbian et Luks/Cryptsetup</a></li>
<li><a href="http://docs.kali.org/kali-dojo/04-raspberry-pi-with-luks-disk-encryption">Raspberry Pi Disk Encryption</a></li>
</ul>
<p>Stay logged in as <em>root</em>.</p>
<div class="highlight"><pre><span></span><code><span class="nb">echo</span> <span class="s2">&quot;initramfs initramfs.gz 0x00f00000&quot;</span> &gt;&gt; /boot/config.txt
cat /boot/config.txt

cat /boot/cmdline.txt
sed -e <span class="s2">&quot;s|root=/dev/mmcblk0p2|root=/dev/mapper/hddcrypt cryptdevice=/dev/sda1:hddcrypt|&quot;</span> -i /boot/cmdline.txt
cat /boot/cmdline.txt <span class="c1"># Check it has been effectively changed</span>

sed -e <span class="s2">&quot;s|/dev/mmcblk0p2|/dev/mapper/hddcrypt|&quot;</span> -i /etc/fstab
cat /etc/fstab <span class="c1"># Make sure it&#39;s all right</span>
<span class="nb">echo</span> -e <span class="s2">&quot;hddcrypt\t/dev/sda1\tnone\tluks&quot;</span> &gt;&gt; /etc/crypttab
cat /etc/crypttab

lsblk <span class="c1"># Identify the hard disk drive connected to the Pi</span>
fdisk /dev/sda <span class="c1"># Delete any existing partition, create new one with default choices</span>
apt install cryptsetup
cryptsetup --verify-passphrase -c aes-xts-plain64 -s <span class="m">512</span> -h sha256 luksFormat /dev/sda1
<span class="c1"># 512-bit AES encryption with 256-bit SHA hashing algorithm</span>
cryptsetup -v luksOpen /dev/sda1 hddcrypt
mkfs.ext4 /dev/mapper/hddcrypt -L ROOT_HDD -m <span class="m">1</span>

<span class="c1"># Let&#39;s mount in two directories the unencrypted root partition from the SD card</span>
<span class="c1"># and the new encrypted root partition from the HDD</span>
mkdir /tmp/rootplain <span class="o">&amp;&amp;</span> mount /dev/mmcblk0p2 /tmp/rootplain/
mkdir /tmp/rootcrypt <span class="o">&amp;&amp;</span> mount /dev/mapper/hddcrypt /tmp/rootcrypt/
rsync -a /tmp/rootplain/ /tmp/rootcrypt/ <span class="c1"># Copy from plain to encrypted</span>
sync

mkinitramfs -o /boot/initramfs.gz <span class="k">$(</span>uname -r<span class="k">)</span>
reboot

<span class="c1"># Delete old /root</span>
su
dd <span class="k">if</span><span class="o">=</span>/dev/urandom <span class="nv">of</span><span class="o">=</span>/dev/mmcblk0p2 <span class="nv">bs</span><span class="o">=</span>10M <span class="nv">status</span><span class="o">=</span>progress <span class="nv">conv</span><span class="o">=</span>fsync
fdisk /dev/mmcblk0 <span class="c1"># Delete second partition</span>
</code></pre></div>

<h3 id="enable-remote-unlocking">Enable remote unlocking</h3>
<p>References:</p>
<ul>
<li><a href="https://stinkyparkia.wordpress.com/2014/10/14/remote-unlocking-luks-encrypted-lvm-using-dropbear-ssh-in-ubuntu-server-14-04-1-with-static-ipst/">Remote unlocking LUKS encrypted LVM using Dropbear SSH in Ubuntu Server 14.04.1 (with Static IP)</a></li>
<li><a href="https://chicagolug.org/news/2015-10-09-remotely-unlock-encrypted-server-with-dropbear.html">Remotely Unlocking Encrypted Servers with Dropbear (on Ubuntu)</a></li>
</ul>
<p>Let's get started! On your Pi:</p>
<div class="highlight"><pre><span></span><code>su
apt install dropbear
mkinitramfs -o /boot/initramfs.gz <span class="k">$(</span>uname -r<span class="k">)</span> <span class="c1"># Triggers SSH key generation</span>

<span class="c1"># Next command is really important, it gives the Pi enough time to get an IP address</span>
sed <span class="s2">&quot;s/configure_networking\ \&amp;/echo \&quot;Waiting 5secs...\&quot;\nsleep\ 5\nconfigure_networking\/&quot;</span> -i /usr/share/initramfs-tools/scripts/init-premount/dropbear
cat /usr/share/initramfs-tools/scripts/init-premount/dropbear

<span class="nb">cd</span> /etc/dropbear/
rm /etc/initramfs-tools/etc/dropbear/dropbear_dss_host_key
rm /etc/initramfs-tools/etc/dropbear/dropbear_rsa_host_key
<span class="c1"># Next command improves security. Default length is 1024</span>
dropbearkey -t rsa -s <span class="m">4096</span> -f /etc/initramfs-tools/etc/dropbear/dropbear_rsa_host_key
</code></pre></div>

<p>Now, add the following at the beginning of the first line of the file <code>/etc/initramfs-tools/root/.ssh/authorized_keys</code>:</p>
<div class="highlight"><pre><span></span><code>command=&quot;/scripts/local-top/cryptroot &amp;&amp; kill -9 `ps | grep -m 1 &#39;cryptroot&#39; | cut -d &#39; &#39; -f 3`&quot;
</code></pre></div>

<p>To forbid authentication using passwords and to change the listening port used by Dropbear, create the file <code>/etc/initramfs-tools/conf.d/dropbear</code> and add:</p>
<div class="highlight"><pre><span></span><code>export PKGOPTION_dropbear_OPTION=&quot;-s -p 1234&quot;
</code></pre></div>

<p>And do:</p>
<div class="highlight"><pre><span></span><code>mkinitramfs -o /boot/initramfs.gz <span class="k">$(</span>uname -r<span class="k">)</span> <span class="c1"># Might be useless</span>
update-initramfs -u
</code></pre></div>

<p>From now, you have 3 possibilities to access your Raspberry Pi remotely:</p>
<ol>
<li>Using a public key</li>
<li>Using the Raspberry's private key</li>
<li>Using an account's password</li>
</ol>
<p>The two first possibilities are quite safe, compared to the third one. It's well known that authentication using passwords over SSH is not that safe.<br>
Using your PC's SSH public key is a good solution but not reliable in the long term. Imagine you were to lose access to your personal computer, you would end up locked out of your Raspberry with no means to access it. On the other hand, using your Raspberry Pi's SSH private as an identity is far more convenient in that you can store that file on many devices. Should you lose you computer, you could still access your Raspberry from another computer, given that you still have access to that private key. I know it's not the safest solution but that's the one I chose to go with.</p>
<p>So here are how to do it with those two first choices, but I recommend you to go with the second one.</p>
<h4 id="choice-1">Choice 1</h4>
<div class="highlight"><pre><span></span><code><span class="nb">echo</span> <span class="k">$(</span>cat /home/pipi/.ssh/authorized_keys<span class="k">)</span> &gt;&gt; /etc/initramfs-tools/root/.ssh/authorized_keys <span class="c1"># Will grant us direct SSH access</span>
cat /etc/initramfs-tools/root/.ssh/authorized_keys <span class="c1"># Make sure it&#39;s all right</span>
</code></pre></div>

<h4 id="choice-2">Choice 2</h4>
<p>Save the content of <code>/etc/initramfs-tools/root/.ssh/id_rsa</code> on your computer. <strong>Make sure to copy the entire file, including first and last lines.</strong> And do that on the newly created file, on your computer:</p>
<div class="highlight"><pre><span></span><code>chmod <span class="m">0600</span> id_rsa_rpi
</code></pre></div>

<p>Now, you can connect to your Pi like this:</p>
<div class="highlight"><pre><span></span><code>ssh -i id_rsa_rpi root@192.168.1.XX -v -p <span class="m">1234</span>
</code></pre></div>

<p><br /></p>
<p>Finally, last step:</p>
<div class="highlight"><pre><span></span><code>update-rc.d dropbear disable <span class="c1"># Only openssh will be used after partition is decrypted</span>
mkinitramfs -o /boot/initramfs.gz <span class="k">$(</span>uname -r<span class="k">)</span> <span class="c1"># Might be useless</span>
update-initramfs -u
reboot
</code></pre></div>

<p>For more information in this whole thing, read the official documentation provided by cryptsetup:</p>
<div class="highlight"><pre><span></span><code>zcat /usr/share/doc/cryptsetup/README.remote.gz
</code></pre></div>

<p>Should you need to upgrade your firmware, make sure to update the right initramfs before rebooting. Read the end of <a href="http://chezmanu.eu/RPI-Chiffrement.php">this article</a> to find out how to do it.</p>
<p>Instead of unlocking your hard disk drive over SSH, if you prefer to use a keyfile, <a href="http://longsteve.com/wiki/index.php?title=USB_Hard_Drive_Encryption_on_a_Raspberry_Pi">check out this website</a>.</p>
<p>If you are brave enough, have a look at the section below called <em>Hardening security</em>. You might want to improve Dropbear settings.</p>
<p>You might also want to read about <a href="https://wiki.mozilla.org/Security/Guidelines/OpenSSH">Mozilla's recommandation in terms of SSH security</a>.</p>
<h1 id="tips">Tips</h1>
<h2 id="screen-blank-time">Screen blank time</h2>
<p>To avoid screen blanking after a while in the console (tty), change <code>BLANK_TIME</code> to 0 in /etc/kbd/config.</p>
<h2 id="auto-login">Auto login</h2>
<p>As previously seen, the tool <code>rasp-config</code> allows you to configure auto login. But you can also do this with the command line. In <em>/etc/inittab</em>, replace</p>
<div class="highlight"><pre><span></span><code>1:2345:respawn:/sbin/getty 115200 tty1
</code></pre></div>

<p>with</p>
<div class="highlight"><pre><span></span><code>1:2345:respawn:/bin/login -f pi tty1 &lt;/dev/tty1 &gt;/dev/tty1 2&gt;&amp;1
</code></pre></div>

<h2 id="stopping-raspberry-pi-from-auto-changing-source-on-tv">Stopping Raspberry-Pi from auto changing source on TV</h2>
<div class="highlight"><pre><span></span><code>sudo <span class="nb">echo</span> <span class="s2">&quot;hdmi_ignore_cec_init=1&quot;</span> &gt;&gt; /boot/config.txt
</code></pre></div>

<h2 id="auto-mount-an-external-hard-disk-drive">Auto-mount an external hard disk drive</h2>
<div class="highlight"><pre><span></span><code>mkdir /home/pi/my_wonderful_hdd <span class="c1"># Where the HDD will be mounted</span>
sudo fdisk -l <span class="c1"># Note the location of the HDD (something like /dev/sda1)</span>
sudo mount -t auto /dev/sda1 /home/pi/my_wonderful_hdd <span class="c1"># Mount it now</span>
sudo <span class="nb">echo</span> <span class="s2">&quot;/dev/sda1 /home/pi/my_wonderful_hdd auto noatime 0 0&quot;</span> &gt;&gt; /etc/fstab <span class="c1"># Auto mount at boot</span>
</code></pre></div>

<h2 id="change-hostname">Change hostname</h2>
<p>Use the tool <code>rasp-config</code> or edit both <em>/etc/hostname</em> and <em>/etc/hosts</em>.</p>
<h2 id="disable-swap-permanently">Disable SWAP permanently</h2>
<p>Swapping is bad for your SD card lifespan. You should disable it permanently. You might however want to keep swap on a partition on a hard disk drive (see above). To disable permatently on SD card and disk, run:</p>
<div class="highlight"><pre><span></span><code>sudo swapoff --all <span class="c1"># Temporary, disables also dedicated partitions (like /dev/sda2)</span>
sudo update-rc.d dphys-swapfile remove
sudo apt remove dphys-swapfile <span class="c1"># Permanently</span>
sudo rm /var/swap
</code></pre></div>

<h1 id="dynhost">DynHost</h1>
<ol>
<li>Run <code>apt install lynx dnsutils git</code> as root. <code>dnsutils</code> provides <code>dig</code>.</li>
<li>As a normal user, run <code>git clone https://github.com/rpellerin/dynhost.git $HOME/dynhost</code></li>
<li>Edit the lines <code>HOST</code>, <code>LOGIN</code>, <code>PASSWORD</code> and <code>PATH_APP</code> in the file <em>dynhost</em>.</li>
<li>
<p>Add a cronjob (<code>crontab -e</code>), on your Pi, with the same user (not root!):</p>
<div class="highlight"><pre><span></span><code>*/5 * * * * /home/pi/dynhost/dynhost
</code></pre></div>

<p>All good!</p>
</li>
</ol>
<h1 id="configure-a-local-smtp-email-server">Configure a local SMTP email server</h1>
<p>Before doing this. make sure you did set the hostname of your Raspberry Pi through <code>raspi-config</code>. Note: to successfully send email, the domain you set must exist as a valid DNS entry. Otherwise some email servers will reject your emails. If your Raspberry won't answer to no domain, let as is but make sure while setting up exim4 to hide local mail name with <strong>an existing domain</strong>.</p>
<p>Make sure to disable <code>/var/log</code> from being in RAM since Exim4 needs <code>/var/log/exim4/mainlog</code> to exist, even after a reboot.</p>
<p>This is pretty convient as some programs still prefer to send emails, such as <code>cron</code>.<br>
Normally, Exim4 comes pre-installed with Debian. If not, do <code>apt install exim4</code>. Then:</p>
<div class="highlight"><pre><span></span><code>su
dpkg-reconfigure exim4-config
<span class="c1"># &quot;mail sent by smarthost; no local mail&quot;</span>
<span class="c1"># System mail name: keep default; must be a valid FQDN though (ending with .com for example). Leaving blank is the same as reusing the same hostname you set for the Raspberry but it is sometimes buggy. Better to explicitely write your hostname.</span>
<span class="c1"># IP-addresses to listen on: keep default, we don&#39;t want to receive external emails</span>
<span class="c1"># Other destinations: leave blank</span>
<span class="c1"># Machines to relay mail for: leave blank</span>
<span class="c1"># IP address or host name of the outgoing smarthost: your SMTP server with port, like ssl0.ovh.net::465</span>
<span class="c1"># Hide local mail name: no, or yes if you let &#39;System mail name&#39; blank. If you set a domain, it MUST EXIST otherwise some server will reject your emails.</span>
<span class="c1"># Keep number of DNS-queries minimal: no</span>
<span class="c1"># Delivery method for local mail: mbox</span>
<span class="c1"># Split configuration into small files: no</span>
<span class="c1"># Root and postmaster mail recipient: write one of your email addresses or leave blank</span>
</code></pre></div>

<p><code>update-exim4.conf</code> should look like this:</p>
<div class="highlight"><pre><span></span><code>dc_eximconfig_configtype=&#39;satellite&#39;
dc_other_hostnames=&#39;&#39;
dc_local_interfaces=&#39;127.0.0.1 ; ::1&#39;
dc_readhost=&#39;&lt;YOUR HOSTNAME&gt;&#39;
dc_relay_domains=&#39;&#39;
dc_minimaldns=&#39;false&#39;
dc_relay_nets=&#39;&#39;
dc_smarthost=&#39;ssl0.ovh.net::465&#39;
CFILEMODE=&#39;644&#39;
dc_use_split_config=&#39;false&#39;
dc_hide_mailname=&#39;true&#39;
dc_mailname_in_oh=&#39;true&#39;
dc_localdelivery=&#39;mail_spool&#39;
</code></pre></div>

<p>Then, <code>cat /etc/mailname</code> and make sure the system mail name you just specified is correctly reported here.</p>
<p>In <em>/etc/exim4/passwd.client</em>, add you credentials, like:</p>
<div class="highlight"><pre><span></span><code>ssl0.ovh.net:me@mydomain.com:password
</code></pre></div>

<p>If your SMTP server uses port 465 with SSL, you'll need to edit <em>/etc/exim4/exim4.conf.template</em>. Add the following line, after <code>driver = smtp</code>, under <code>remote_smtp_smarthost</code>:</p>
<div class="highlight"><pre><span></span><code>protocol = smtps
</code></pre></div>

<p><a href="http://www.gossamer-threads.com/lists/exim/users/96817">More information</a>.</p>
<p>Now add these lines in <em>/etc/aliases</em> (changes the lines according to your needs):</p>
<div class="highlight"><pre><span></span><code>root: &lt;your email address&gt;
pipi: root
</code></pre></div>

<p>Any email intended for user1 will be sent to the corresponding email address. <strong>Do not add addresses using the same domain you chose while configuring exim4 as the emails won't be sent out.</strong><br>
You can also edit <em>/etc/email-addresses</em>: this file contains addresses used for <em>from</em>, <em>reply-to</em> and <em>sender addresses</em> fields.</p>
<p>Then:</p>
<div class="highlight"><pre><span></span><code>newaliases <span class="c1"># To apply changes brought to aliases</span>
update-exim4.conf
<span class="c1"># /etc/init.d/exim4 restart</span>
systemctl restart exim4
<span class="nb">echo</span> <span class="s2">&quot;This is a test.&quot;</span> <span class="p">|</span> mail -s <span class="s2">&quot;test message&quot;</span> anotherme@somewhere.com <span class="c1"># Try sending an email</span>
<span class="nb">echo</span> <span class="s2">&quot;This is a test.&quot;</span> <span class="p">|</span> mail -s <span class="s2">&quot;test message for root&quot;</span> root <span class="c1"># Try sending an email</span>
runq<span class="p">;</span> exim -qff <span class="c1"># Flush all email queues</span>
</code></pre></div>

<p><a href="http://debian-facile.org/doc:reseau:exim4:redirection-mails-locaux">More information</a>.</p>
<h1 id="send-email-automatically-on-startup-with-sendmail">Send email automatically on startup with <code>sendmail</code></h1>
<p>Add the following in <code>crontab -e</code> as root:</p>
<div class="highlight"><pre><span></span><code>@reboot /bin/sleep <span class="m">30</span><span class="p">;</span> /usr/sbin/exim -qff<span class="p">;</span> <span class="nb">echo</span> <span class="s2">&quot;So you know... (</span><span class="k">$(</span>date<span class="k">)</span><span class="s2">)&quot;</span> <span class="p">|</span> mail -s <span class="s2">&quot;Rpi turned on&quot;</span> root
</code></pre></div>

<p>Now, read the section right below.</p>
<h1 id="send-emails-automatically-on-shell-login">Send emails automatically on shell login</h1>
<p>Edit your user and root's <code>.bashrc</code> and add at the end of the file:</p>
<div class="highlight"><pre><span></span><code><span class="nb">echo</span> <span class="s2">&quot;So you know... (</span><span class="k">$(</span>date<span class="k">)</span><span class="s2">)&quot;</span> <span class="p">|</span> mail -s <span class="s2">&quot;Root shell login&quot;</span> root
</code></pre></div>

<h1 id="installing-nextcloud">Installing Nextcloud</h1>
<p>Official tutorial: <a href="https://docs.nextcloud.com/server/latest/admin_manual/installation/source_installation.html">https://docs.nextcloud.com/server/latest/admin_manual/installation/source_installation.html</a>.</p>
<p>(<a href="https://kiramclean.com/blog/how-to-set-up-your-own-nextcloud-server/">here is another tutorial on how to install Nextcloud via SNAP</a>)</p>
<details>
    <summary>Click here to know how to support HTTP2</summary>
[Note that Apache prefork (which is used by `libapache2-mod-php`) is not compatible with HTTP2](https://http2.pro/doc/Apache). We have to [use fpm](https://blog.feutl.com/nextcloud-http2/). Here are some instructions on how to support HTTP2:

1.  Follow the instructions below but do no install `libapache2-mod-php`, instead install `php-fpm`.
1.  After setting up the database, do:

        :::bash
        su
        # If necessary, run the following
        # systemctl stop apache2
        # a2dismod php7.3
        # apt purge libapache2-mod-php
        a2dismod mpm_prefork
        a2enmod mpm_event proxy_fcgi setenvif
        a2enmod http2
        a2enconf php7.3-fpm # Check the generated conf file in /etc/apache2/conf-enabled, if not needed remove the file or disable the conf

1.  Keep reading the instructions. When editing `/etc/apache2/sites-enables/default-ssl.conf`, add these lines in the virtual host:

        :::text
        <VirtualHost *:443>
            ...
            <FilesMatch \.php$>
                SetHandler "proxy:unix:/run/php/php7.3-fpm.sock|fcgi://localhost/"
            </FilesMatch>
            ...
            ProtocolsHonorOrder On
            Protocols h2 h2c http/1.1
            ...

1.  [Tune PHP-FPM](https://docs.nextcloud.com/server/latest/admin_manual/installation/server_tuning.html#tune-php-fpm).
1.  Copy the lines `php_value` from `/var/www/nextcloud/.htaccess` [to `/var/www/nextcloud/.htaccess`](https://medium.com/@jacksonpauls/moving-from-mod-php-to-php-fpm-914125a7f336).
1.  `systemctl reload php7.3-fpm && systemctl restart apache2`
1.  Check if Apache2 MPM is changed to events: `sudo apachectl -V | grep MPM`
1.  See [Nextcloud's instructions on the php.ini file](https://docs.nextcloud.com/server/latest/admin_manual/installation/source_installation.html#php-ini-configuration-notes).

</details>

<div class="highlight"><pre><span></span><code>su
apt install apache2 mariadb-server libapache2-mod-php
apt install php-gd php-json php-mysql php-curl php-mbstring
apt install php-intl php-imagick imagemagick php-xml php-zip php-bz2
systemctl restart apache2

<span class="nb">cd</span> /var/www
mkdir nextcloud
wget https://download.nextcloud.com/server/releases/nextcloud-20.0.4.zip
sha256sum -c &lt;<span class="o">(</span>wget -q https://download.nextcloud.com/server/releases/nextcloud-20.0.4.zip.sha256 -O -<span class="o">)</span> &lt; nextcloud-20.0.4.zip
unzip nextcloud-20.0.4.zip
chown -R www-data:www-data /var/www/nextcloud/

mysql -u root -p <span class="c1"># No password is required, just hit enter</span>
CREATE USER <span class="s1">&#39;nextclouduser&#39;</span>@<span class="s1">&#39;localhost&#39;</span> IDENTIFIED BY <span class="s1">&#39;Password&#39;</span><span class="p">;</span>
create database nextcloud<span class="p">;</span>
GRANT ALL PRIVILEGES ON nextcloud.* TO <span class="s1">&#39;nextclouduser&#39;</span>@<span class="s1">&#39;localhost&#39;</span><span class="p">;</span>
flush privileges<span class="p">;</span>
exit<span class="p">;</span>

mysql -u nextclouduser -p <span class="c1"># Make sure it worked</span>
mysql_secure_installation

a2enmod ssl
a2ensite default-ssl <span class="c1"># Enable HTTPS website</span>

apachectl -M <span class="c1"># Check modules enabled</span>
<span class="c1"># Enable the following if not already done</span>
a2enmod rewrite
a2enmod headers
a2enmod env
a2enmod dir
a2enmod mime
systemctl restart apache2
systemctl disable apache2 <span class="c1"># No auto start on boot</span>
</code></pre></div>

<p>Now edit <code>/etc/apache2/sites-enabled/000-default.conf</code>. It must contain the following (note that the redirection to https can be automatically added by Let's Encrypt, see farther below):</p>
<div class="highlight"><pre><span></span><code>Alias / &quot;/var/www/nextcloud/&quot;
&lt;Directory &quot;/var/www/nextcloud&quot;&gt;
    Options +FollowSymLinks
    AllowOverride All

    &lt;IfModule mod_dav.c&gt;
        Dav off
    &lt;/IfModule&gt;

    SetEnv HOME /var/www/nextcloud
    SetEnv HTTP_HOME /var/www/nextcloud
&lt;/Directory&gt;

&lt;Directory &quot;/mnt/data_partition/&quot;&gt;
    # just in case if .htaccess gets disabled
    Require all denied
&lt;/Directory&gt;

&lt;VirtualHost *:80&gt;
    ServerName &lt;YOUR DOMAIN&gt;
    ServerAdmin &lt;YOUR EMAIL ADDRESS&gt;
    DocumentRoot /var/www/nextcloud

    ErrorLog ${APACHE_LOG_DIR}/error.log
    CustomLog ${APACHE_LOG_DIR}/access.log combined

    Redirect permanent / https://&lt;YOUR DOMAIN&gt;/
&lt;/VirtualHost&gt;
</code></pre></div>

<p>Bring the changes between <code>&lt;VirtualHost&gt;</code> tags to <em>/etc/apache2/sites-enables/default-ssl.conf</em>, except for the instruction <code>Redirect</code>. Additionally, add instructions taken from <a href="https://mozilla.github.io/server-side-tls/ssl-config-generator/?server=apache-2.4.25&amp;openssl=1.1.0j&amp;hsts=yes&amp;profile=modern">Mozilla SSL Configuration Generator</a>:</p>
<div class="highlight"><pre><span></span><code>&lt;VirtualHost *:443&gt;
    ...
    # SSLEngine on # We&#39;ll uncomment this later

    # HSTS (mod_headers is required) (15552000 seconds = 6 months)
    Header always set Strict-Transport-Security &quot;max-age=15552000; includeSubDomains&quot;
    ...
&lt;/VirtualHost&gt;

# modern configuration, tweak to your needs
SSLProtocol             all -SSLv3 -TLSv1 -TLSv1.1
SSLCipherSuite          ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256
SSLHonorCipherOrder     on
SSLCompression          off
SSLSessionTickets       off

# OCSP Stapling, only in httpd 2.3.3 and later
SSLUseStapling          on
SSLStaplingResponderTimeout 5
SSLStaplingReturnResponderErrors off
SSLStaplingCache        shmcb:/var/run/ocsp(128000)
</code></pre></div>

<p>Let us now improve a bit Apache's security. Edit <em>/etc/apache2/conf-enabled/security.conf</em> like this:</p>
<div class="highlight"><pre><span></span><code>ServerSignature Off
Header set X-Frame-Options: &quot;sameorigin&quot; # Require mod_headers
ServerTokens Prod
</code></pre></div>

<p>Now get a browser-trusted certificate from <a href="https://letsencrypt.org/">Let's Encrypt</a>. Here is a summary of <a href="https://certbot.eff.org/lets-encrypt/debianbuster-apache">the official instructions</a>:</p>
<div class="highlight"><pre><span></span><code>su
apt update
apt install snapd
<span class="nb">exit</span>
su <span class="c1"># To reload paths</span>
snap install core
snap refresh core
snap install --classic certbot
ln -s /snap/bin/certbot /usr/bin/certbot

<span class="c1"># Set up NAT/PAT rules in your router so that ports 80 and 443 are reachable from the Internet. Then:</span>
certbot --apache
<span class="c1"># Now uncomment SSLEngine on in default-ssl.conf</span>
certbot renew --dry-run <span class="c1"># Try renewal</span>
<span class="c1"># It should be programmed to regularily renew the certificate automatically.</span>
<span class="c1"># Check with `systemctl list-timers`.</span>
</code></pre></div>

<p>And restart <code>systemctl restart apache2</code>.</p>
<p>Now, visit http://raspberry-pi-IP/ once. This will create <code>/var/www/nextcloud/config/config.php</code>. Edit this file like this:</p>
<div class="highlight"><pre><span></span><code><span class="s1">&#39;overwrite.cli.url&#39;</span> <span class="o">=</span>&gt; <span class="s1">&#39;https://example.org/&#39;</span>,
<span class="s1">&#39;htaccess.RewriteBase&#39;</span> <span class="o">=</span>&gt; <span class="s1">&#39;/&#39;</span>,
</code></pre></div>

<p>And run <code>cd /var/www/nextcloud &amp;&amp; sudo -u www-data php occ maintenance:update:htaccess</code>.</p>
<p>Ultimately, verify everything is all right using <a href="https://www.ssllabs.com/ssltest/">SSL LABS's SSL server test</a>.</p>
<p>You may now restart Apache2.</p>
<p>Then:</p>
<div class="highlight"><pre><span></span><code>cryptsetup -v luksOpen /dev/sda3 hddcrypt
mount /dev/mapper/hddcrypt /mnt/data_partition/
mkdir /mnt/data_partition/nextcloud_data
chown -R www-data:www-data /mnt/data_partition/nextcloud_data/
chmod <span class="m">750</span> /mnt/data_partition/nextcloud_data
</code></pre></div>

<p>Now you can start setting up Nextcloud at https://raspberry-pi-IP/. Set the data folder to be <code>/mnt/data_partition/nextcloud_data</code>. Once set up, go visit <code>/settings/admin/overview</code> for tips on how to improve your setup.</p>
<h2 id="improve-phps-performance">Improve PHP's performance</h2>
<div class="highlight"><pre><span></span><code>su

<span class="nb">export</span> <span class="nv">CONF</span><span class="o">=</span>/etc/php/7.3/apache2/php.ini
<span class="c1"># Or /etc/php/7.3/fpm/php.ini if running HTTP2</span>

sed <span class="s2">&quot;s/;opcache.enable=1/opcache.enable=1/&quot;</span> -i <span class="nv">$CONF</span>
sed <span class="s2">&quot;s/;opcache.enable_cli=0/opcache.enable_cli=1/&quot;</span> -i <span class="nv">$CONF</span>
sed <span class="s2">&quot;s/;opcache.memory_consumption=128/opcache.memory_consumption=128/&quot;</span> -i <span class="nv">$CONF</span>
sed <span class="s2">&quot;s/;opcache.interned_strings_buffer=8/opcache.interned_strings_buffer=8/&quot;</span> -i <span class="nv">$CONF</span>
sed <span class="s2">&quot;s/;opcache.max_accelerated_files=10000/opcache.max_accelerated_files=10000/&quot;</span> -i <span class="nv">$CONF</span>
sed <span class="s2">&quot;s/;opcache.revalidate_freq=2/opcache.revalidate_freq=240/&quot;</span> -i <span class="nv">$CONF</span>
sed <span class="s2">&quot;s/memory_limit = 128M/memory_limit = 512M/&quot;</span> -i <span class="nv">$CONF</span>
sed <span class="s2">&quot;s/upload_max_filesize = 2M/upload_max_filesize = 16G/&quot;</span> -i <span class="nv">$CONF</span>
sed <span class="s2">&quot;s/post_max_size = 8M/post_max_size = 16G/&quot;</span> -i <span class="nv">$CONF</span>
sed <span class="s2">&quot;s/output_buffering = 4096/output_buffering = 0/&quot;</span> -i <span class="nv">$CONF</span>
sed <span class="s2">&quot;s/max_input_time = 60/max_input_time = 3600/&quot;</span> -i <span class="nv">$CONF</span>
sed <span class="s2">&quot;s/max_execution_time = 30/max_execution_time = 3600/&quot;</span> -i <span class="nv">$CONF</span>

<span class="nb">export</span> <span class="nv">CONF_CLI</span><span class="o">=</span>/etc/php/7.3/cli/php.ini
<span class="c1"># /etc/php/7.0/cli/php.ini is used by Nextcloud&#39;s CRON jobs</span>

sed <span class="s2">&quot;s/;opcache.enable=1/opcache.enable=1/&quot;</span> -i <span class="nv">$CONF_CLI</span>
sed <span class="s2">&quot;s/;opcache.enable_cli=0/opcache.enable_cli=1/&quot;</span> -i <span class="nv">$CONF_CLI</span>
sed <span class="s2">&quot;s/;opcache.revalidate_freq=2/opcache.revalidate_freq=240/&quot;</span> -i <span class="nv">$CONF_CLI</span>
sed <span class="s2">&quot;s/output_buffering = 4096/output_buffering = 0/&quot;</span> -i <span class="nv">$CONF_CLI</span>
sed <span class="s2">&quot;s/max_input_time = 60/max_input_time = 3600/&quot;</span> -i <span class="nv">$CONF_CLI</span>
sed <span class="s2">&quot;s/max_execution_time = 30/max_execution_time = 3600/&quot;</span> -i <span class="nv">$CONF_CLI</span>
</code></pre></div>

<p>To significantly improve performance overall, you'll also need data caching: <strong>APCu</strong>.</p>
<div class="highlight"><pre><span></span><code>su
apt install php-apcu
phpenmod apcu
service apache2 restart
</code></pre></div>

<p>Now, add the following in <em>/var/www/nextcloud/config/config.php</em>:</p>
<div class="highlight"><pre><span></span><code>&#39;memcache.local&#39; =&gt; &#39;\OC\Memcache\APCu&#39;,
</code></pre></div>

<p>Restart Apache. Running <code>php -i</code> will say <em>opcache.enable =&gt; On</em> and <em>Opcode Caching =&gt; Up and Runnning</em>. If you temporarily replace the content of <code>status.php</code> with <code>&lt;?php phpinfo(); ?&gt;</code>, when accessing <code>/status.php</code> you should see the same results. Make sure as well that APCu is enabled in the webpage.</p>
<h2 id="improve-nextclouds-settings">Improve Nextcloud's settings</h2>
<p>Add the following in <em>/var/www/nextcloud/config/config.php</em>:</p>
<div class="highlight"><pre><span></span><code>&#39;logtimezone&#39; =&gt; &#39;Europe/Paris&#39;,
&#39;logfile&#39; =&gt; &#39;/var/log/nextcloud/nextcloud.log&#39;,
&#39;default_phone_region&#39; =&gt; &#39;DE&#39;,
</code></pre></div>

<p>Now:</p>
<div class="highlight"><pre><span></span><code>su -
mkdir /var/log/nextcloud
chown www-data:www-data /var/log/nextcloud
<span class="nb">exit</span>
sudo -u www-data bash
touch /var/log/nextcloud/nextcloud.log
</code></pre></div>

<p>In Nextcloud, enable the server-side encryption in the admin settings, and enable the app called <em>Default encryption module</em> in the web interface, while logged in as an admin. You'll need to log out and in to actually enable encryption for good.</p>
<p>Install and enable the app "Two Factor TOTP Provider" in <code>URL/settings/apps</code>. Then, go to <code>URL/settings/user/security</code> and enable TOTP.</p>
<p>In <code>URL/settings/admin</code>, change the jobs mechanism to cron (read the documentation by clicking on the i icon).</p>
<div class="highlight"><pre><span></span><code>*/5  *  *  *  * <span class="o">[</span> -L /dev/mapper/hddcrypt <span class="o">]</span> <span class="o">&amp;&amp;</span> php -f /var/www/nextcloud/cron.php
</code></pre></div>

<h1 id="firewall">Firewall</h1>
<div class="highlight"><pre><span></span><code>su
wget --no-check-certificate https://raw.githubusercontent.com/rpellerin/dotfiles/master/scripts/firewall.sh
wget --no-check-certificate https://raw.githubusercontent.com/rpellerin/dotfiles/master/scripts/firewall.service
chmod <span class="m">700</span> firewall.sh
chmod <span class="m">700</span> firewall.service
chown root:root firewall.sh
chown root:root firewall.service
<span class="c1"># Edit the content of firewall.service so that the path to firewall.sh is correct</span>
mv firewall.service /etc/systemd/system/
systemctl <span class="nb">enable</span> firewall
</code></pre></div>

<p>Edit <code>firewall.sh</code> that way:</p>
<div class="highlight"><pre><span></span><code><span class="nv">TCP_SERVICES</span><span class="o">=</span><span class="s2">&quot;80 443&quot;</span> <span class="c1"># SSH is handled separately elsewhere // http, https</span>
<span class="nv">UDP_SERVICES</span><span class="o">=</span><span class="s2">&quot;68 1194&quot;</span> <span class="c1"># DHCP, OpenVPN</span>

<span class="nv">REMOTE_TCP_SERVICES</span><span class="o">=</span><span class="s2">&quot;21 22 43 80 443 465 993&quot;</span> <span class="c1"># ftp, ssh, whois, http, https, smtp (ssl), imap</span>
<span class="nv">REMOTE_UDP_SERVICES</span><span class="o">=</span><span class="s2">&quot;53 67 123&quot;</span> <span class="c1"># DNS (&quot;whois&quot; command for example), DHCP, ntp (time update)</span>

<span class="c1"># NETWORK_MGMT=192.168.1.0/24</span>
</code></pre></div>

<h1 id="openvpn-247">OpenVPN 2.4.7</h1>
<div class="highlight"><pre><span></span><code>su
apt update <span class="o">&amp;&amp;</span> apt install openvpn
</code></pre></div>

<p>Read the <a href="https://openvpn.net/community-resources/how-to/">official documentation</a> (<a href="https://community.openvpn.net/openvpn/wiki/EasyRSA3-OpenVPN-Howto">here, short tutorial for easy-rsa3</a>).</p>
<div class="highlight"><pre><span></span><code>cp -R /usr/share/easy-rsa/ /etc/openvpn
<span class="nb">cd</span> /etc/openvpn/easy-rsa
cp vars.example vars
<span class="nb">echo</span> <span class="s2">&quot;set_var EASYRSA_KEY_SIZE       2048&quot;</span> &gt;&gt; vars <span class="c1"># No need to source this file</span>
<span class="c1"># Edit also EASYRSA_REQ_COUNTRY, PROVINCE, CITY, ORG, and EMAIL</span>
</code></pre></div>

<p>From now on, I highly recommend you read <em>/etc/openvpn/easy-rsa/doc/EasyRSA-Readme.md</em> and <a href="https://github.com/OpenVPN/easy-rsa/blob/master/README.quickstart.md">https://github.com/OpenVPN/easy-rsa/blob/master/README.quickstart.md</a> in order to continue setting up OpenVPN. As explained, you need to create a PKI to get three distinct things: your CA, a certificate and private key for the server and another couple of this kind for clients. Normally you should generate the pair for clients on your personnal computer, however it's not necessary in our case (who cares about security anyway?).</p>
<p>Then:</p>
<div class="highlight"><pre><span></span><code>./easyrsa init-pki
./easyrsa build-ca <span class="c1"># Add a strong password which will be used to sign other certificates. Leave unchanged the default Common Name.</span>
./easyrsa gen-req server nopass <span class="c1"># Do not add a password for the server; use &#39;server&#39; as the Common Name (CN)</span>
./easyrsa sign-req server server
./easyrsa gen-req client <span class="c1"># Use &#39;client&#39; as CN; add a passphrase that you will need later when you try to connect to your VPN server</span>
./easyrsa sign-req client client
</code></pre></div>

<p>Once the certificates and private keys are generated for the server and a client at least, do the following on your Pi and then go back to reading OpenVPN's documentation:</p>
<div class="highlight"><pre><span></span><code>./easyrsa gen-dh
cp /usr/share/doc/openvpn/examples/sample-config-files/server.conf.gz /etc/openvpn/
cp /usr/share/doc/openvpn/examples/sample-config-files/client.conf /etc/openvpn/
<span class="nb">cd</span> /etc/openvpn
openvpn --genkey --secret ta.key
gunzip server.conf.gz
vim server.conf
</code></pre></div>

<p>You should edit <em>server.conf</em> like this:</p>
<div class="highlight"><pre><span></span><code>port 1194
proto udp
dev tun
ca /etc/openvpn/easy-rsa/pki/ca.crt
cert /etc/openvpn/easy-rsa/pki/issued/server.crt
key /etc/openvpn/easy-rsa/pki/private/server.key
dh /etc/openvpn/easy-rsa/pki/dh.pem
push &quot;route 192.168.1.0 255.255.255.0&quot;
push &quot;redirect-gateway def1 bypass-dhcp&quot;
push &quot;dhcp-option DNS 208.67.222.222&quot;
push &quot;dhcp-option DNS 208.67.220.220&quot;
tls-auth /etc/openvpn/ta.key 0
cipher AES-256-CBC
comp-lzo
max-clients 2
user nobody
group nogroup
log-append  openvpn.log
verb 6
mute 20
script-security 3
client-connect &quot;/etc/openvpn/notifyconnect.sh&quot;
</code></pre></div>

<p>Keep the rest as-is. Now create <code>/etc/openvpn/notifyconnect.sh</code>:</p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/bash</span>
<span class="nb">echo</span> <span class="s2">&quot;On `date`&quot;</span> <span class="p">|</span> mail -s <span class="s2">&quot;OpenVPN client connection&quot;</span> root@localhost <span class="m">2</span>&gt;/dev/null
sleep <span class="m">1</span>
<span class="c1"># We can&#39;t run `runq`  or `exim -qff` since this script is called by user `nobody`.</span>
<span class="c1"># Also make sure this script returns 0 otherwise the VPN connection will fail.</span>
</code></pre></div>

<p>Then:</p>
<div class="highlight"><pre><span></span><code>chmod +x /etc/openvpn/notifyconnect.sh
</code></pre></div>

<p>Now, edit <em>client.conf</em>:</p>
<div class="highlight"><pre><span></span><code>remote &lt;your DynHost domain&gt; 1194
user nobody
group nogroup
mute-replay-warnings
# Normally next lines are uncommented but we won&#39;t need them
#ca /etc/openvpn/easy-rsa/easyrsa3/pki/ca.crt
#cert /etc/openvpn/easy-rsa/easyrsa3/pki/issued/client.crt
#key /etc/openvpn/easy-rsa/easyrsa3/pki/private/client.key
#tls-auth /etc/openvpn/ta.key 1
remote-cert-tls server
cipher AES-256-CBC
comp-lzo
mute 20
</code></pre></div>

<p>Ultimately do:</p>
<div class="highlight"><pre><span></span><code>cat /etc/openvpn/client.conf &gt; client.ovpn
<span class="nb">echo</span> <span class="s2">&quot;key-direction 1&quot;</span> &gt;&gt; client.ovpn
<span class="nb">echo</span> <span class="s2">&quot;script-security 2&quot;</span> &gt;&gt; client.ovpn
<span class="nb">echo</span> <span class="s2">&quot;up /etc/openvpn/update-resolv-conf&quot;</span> &gt;&gt; client.ovpn
<span class="nb">echo</span> <span class="s2">&quot;down /etc/openvpn/update-resolv-conf&quot;</span> &gt;&gt; client.ovpn
<span class="nb">echo</span> <span class="s2">&quot;&lt;ca&gt;&quot;</span> &gt;&gt; client.ovpn
cat /etc/openvpn/easy-rsa/pki/ca.crt &gt;&gt; client.ovpn
<span class="nb">echo</span> <span class="s2">&quot;&lt;/ca&gt;&quot;</span> &gt;&gt; client.ovpn
<span class="nb">echo</span> <span class="s2">&quot;&lt;cert&gt;&quot;</span> &gt;&gt; client.ovpn
cat /etc/openvpn/easy-rsa/pki/issued/client.crt <span class="p">|</span> sed -ne <span class="s1">&#39;/-BEGIN CERTIFICATE-/,/-END CERTIFICATE-/p&#39;</span> &gt;&gt; client.ovpn
<span class="nb">echo</span> <span class="s2">&quot;&lt;/cert&gt;&quot;</span> &gt;&gt; client.ovpn
<span class="nb">echo</span> <span class="s2">&quot;&lt;key&gt;&quot;</span> &gt;&gt; client.ovpn
cat /etc/openvpn/easy-rsa/pki/private/client.key &gt;&gt; client.ovpn
<span class="nb">echo</span> <span class="s2">&quot;&lt;/key&gt;&quot;</span> &gt;&gt; client.ovpn
<span class="nb">echo</span> <span class="s2">&quot;&lt;tls-auth&gt;&quot;</span> &gt;&gt; client.ovpn
cat /etc/openvpn/ta.key &gt;&gt; client.ovpn
<span class="nb">echo</span> <span class="s2">&quot;&lt;/tls-auth&gt;&quot;</span> &gt;&gt; client.ovpn
</code></pre></div>

<p>Copy that <em>client.ovpn</em> file on your client.</p>
<p>On your Pi, uncomment the following line in <em>/etc/sysctl.conf</em>:</p>
<div class="highlight"><pre><span></span><code>net.ipv4.ip_forward=1
</code></pre></div>

<p>Apply changes:</p>
<div class="highlight"><pre><span></span><code>su
sysctl -p
</code></pre></div>

<p>There's a <a href="http://serverfault.com/questions/355520/after-reboot-debian-box-ignore-sysctl-conf-values">known bug</a> which may prevent these values to be read on boot (check that it worked about rebooting with <code>sysctl -a | grep ip_forward</code>). Add the following above <code>exit 0</code> in <em>/etc/rc.local</em>:</p>
<div class="highlight"><pre><span></span><code>sysctl -p /etc/sysctl.conf
</code></pre></div>

<p>Don't forget to set up a port forward rule to forward UDP port 1194 from your gateway/router to the machine running the OpenVPN server. In addition, allow incomings UDP connections on port 1194 and these rules, in <code>firewall.sh</code> (the lines are there already, uncomment them):</p>
<div class="highlight"><pre><span></span><code>iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
iptables -A FORWARD -s <span class="m">10</span>.8.0.0/24 -j ACCEPT
iptables -A FORWARD -m state --state RELATED,ESTABLISHED -j ACCEPT
</code></pre></div>

<p>Finally, do the following on your server:</p>
<div class="highlight"><pre><span></span><code><span class="nb">cd</span> /etc/openvpn
su
mv client.conf client.conf.old
shred -u client.ovpn
systemctl restart openvpn
tail -f /var/log/openvpn/openvpn.log
</code></pre></div>

<p>At next boot, the server will run automatically. We needed to rename the <em>client.ovpn</em> because the initscript will scan this directory for <em>.conf</em> files and start up a separate OpenVPN deamon for each file found. It is recommended to delete client's files:</p>
<div class="highlight"><pre><span></span><code>shred -u client.conf.old
shred -u /etc/openvpn/easy-rsa/pki/private/client.key
shred -u /etc/openvpn/easy-rsa/pki/issued/client.crt
</code></pre></div>

<p>Now on your client:</p>
<div class="highlight"><pre><span></span><code>sudo apt update <span class="o">&amp;&amp;</span> sudo apt install resolvconf
sudo openvpn --config client.ovpn
</code></pre></div>

<p>Add <code>CAP_SYS_RESOURCE</code> to <code>CapabilityBoundingSet</code> in <code>/lib/systemd/system/openvpn@.service</code>. <a href="https://alexaf.gitlab.io/posts/broken_vpn_notifications/">Here is why</a>.</p>
<h2 id="optional-use-several-ports">Optional: use several ports</h2>
<p>You might want to make your VPN server available on several ports. If so, open the ports you wish to use on your router and add the corresponding iptables rules. You may edit <code>firewall.sh</code>, change the first line and add the second one:</p>
<div class="highlight"><pre><span></span><code><span class="nv">UDP_SERVICES</span><span class="o">=</span><span class="s2">&quot;68 1194 53&quot;</span> <span class="c1"># DCHP, OpenVPN, OpenVPN (other port)</span>
<span class="c1"># ...</span>
iptables -t nat -A PREROUTING -i eth0 -p udp --dport <span class="m">53</span> -j REDIRECT --to-port <span class="m">1194</span>
</code></pre></div>

<h1 id="hardening-ssh-configuration">Hardening SSH configuration</h1>
<p>Edit <em>/etc/ssh/sshd_config</em>:</p>
<div class="highlight"><pre><span></span><code>Port &lt;something you like&gt;
# If you change the default port, don&#39;t forget to update SSH_PORT in firewall.sh
#HostKey /etc/ssh/ssh_host_dsa_key # Comment because too old
#HostKey /etc/ssh/ssh_host_ecdsa_key # Same reason
LoginGraceTime 10s
PermitRootLogin no
StrictModes yes
PubkeyAuthentication yes
IgnoreRhosts yes
PasswordAuthentication no # Or yes, depending on your needs
PermitEmptyPasswords no
ChallengeResponseAuthentication no
UsePAM no
Banner /etc/issue.net # Message displayed at login

# Custom settings
AllowUsers pi # ONLY pi will be allowed to log in

Ciphers chacha20-poly1305@openssh.com,aes256-gcm@openssh.com,aes128-gcm@openssh.com,aes256-ctr,aes192-ctr,aes128-ctr
MACs hmac-sha2-512,hmac-sha2-256
KexAlgorithms curve25519-sha256@libssh.org,diffie-hellman-group-exchange-sha256
</code></pre></div>

<p>The last three lines are taken from <a href="https://stribika.github.io/2015/01/04/secure-secure-shell.html">this very helpful website</a>. You should also read <a href="http://kacper.blog.redpill-linpro.com/archives/702">this one</a> after having read the first one (the order is important).</p>
<p><a href="http://mysecureshell.sourceforge.net/fr/securessh.html#question3">Another helpful website about how to prevent SSH bruteforce attacks</a>. However, we'll use fail2ban, see below.</p>
<p>Consider allowing SSH connections using public keys only. On a client do:</p>
<div class="highlight"><pre><span></span><code><span class="n">ssh</span><span class="o">-</span><span class="n">keygen</span><span class="w"> </span><span class="o">-</span><span class="n">t</span><span class="w"> </span><span class="n">rsa</span><span class="w"> </span><span class="o">-</span><span class="n">b</span><span class="w"> </span><span class="mi">4096</span><span class="w"> </span><span class="o">-</span><span class="n">o</span><span class="w"> </span><span class="o">-</span><span class="n">a</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="n">Accept</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="n">directory</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="k">no</span><span class="w"> </span><span class="n">passphrase</span><span class="w"></span>
<span class="n">ssh</span><span class="o">-</span><span class="n">copy</span><span class="o">-</span><span class="n">id</span><span class="w"> </span><span class="o">-</span><span class="n">i</span><span class="w"> </span><span class="o">~/</span><span class="p">.</span><span class="n">ssh</span><span class="o">/</span><span class="n">id_rsa</span><span class="p">.</span><span class="n">pub</span><span class="w"> </span><span class="nf">pi</span><span class="nv">@raspberrypi</span><span class="o">-</span><span class="n">IP</span><span class="w"></span>
</code></pre></div>

<h1 id="sending-an-email-on-every-ssh-connection">Sending an email on every SSH connection</h1>
<p>Taken from <a href="http://askubuntu.com/questions/179889/how-do-i-set-up-an-email-alert-when-a-ssh-login-is-successful#answer-448602">this thread</a>. As root, create <code>/etc/ssh/login-notify.sh</code>:</p>
<div class="highlight"><pre><span></span><code>#!/bin/sh

if [ &quot;$PAM_TYPE&quot; != &quot;close_session&quot; ]; then
    host=&quot;`hostname`&quot;
    subject=&quot;SSH Login: $PAM_USER from $PAM_RHOST on $host&quot;
    message=&quot;`date`&quot;
    echo &quot;$message&quot; | mail -s &quot;$subject&quot; root@mydomain
fi
</code></pre></div>

<p>Note though that you will need to change this line in <code>/etc/ssh/sshd_config</code>:</p>
<div class="highlight"><pre><span></span><code>UsePAM yes
</code></pre></div>

<p>Then:</p>
<div class="highlight"><pre><span></span><code>chmod +x /etc/ssh/login-notify.sh
</code></pre></div>

<p>And add the following line at the end of the file <code>/etc/pam.d/sshd</code>:</p>
<div class="highlight"><pre><span></span><code>session optional pam_exec.so seteuid /etc/ssh/login-notify.sh
</code></pre></div>

<p>Now restart sshd by doing <code>service sshd restart</code>.</p>
<h1 id="fail2ban">Fail2Ban</h1>
<p><a href="http://www.fail2ban.org/wiki/index.php/MANUAL_0_8">Official documentation</a>.</p>
<div class="highlight"><pre><span></span><code>su
apt install fail2ban
systemctl status fail2ban
</code></pre></div>

<p>Make sure the file <em>/etc/init.d/fail2ban</em> exists. Now edit <em>/etc/fail2ban/jail.local</em> (make a copy of <em>/etc/fail2ban/jail.conf</em>):</p>
<div class="highlight"><pre><span></span><code>[DEFAULT]
# Whatever fits you
bantime = 86400
findtime = 3600
maxretry = 3
action = %(action_mwl)s

# Enable sshd (enabled = true + mode = aggressive), change &#39;port&#39; if need be
# Enable apache, apache-*
# Add the following new entry
[http-dos]
enabled = true
port = http,https
filter = http-dos
logpath = %(apache_access_log)s
maxretry = 200
findtime = 120
bantime = 600

[ban-countries]
enabled = true
port = http,https
filter = http-dos
logpath = %(apache_access_log)s
maxretry = 1
findtime = 120
bantime = 6000
banaction = ban-countries
action = %(action_)s
# action_ won&#39;t send email when banning someone (cause would send a message for every new request) nor when starting/stopping
</code></pre></div>

<p>In <code>/etc/fail2ban/filter.d/apache-auth.conf</code>, edit the line <code>ignoreregex</code> like this to fix a known issue between <a href="https://github.com/nextcloud/server/issues/15688">Nextcloud and fail2ban</a>:</p>
<div class="highlight"><pre><span></span><code>ignoreregex = var/www/nextcloud/config
</code></pre></div>

<p>Now create <em>/etc/fail2ban/filter.d/http-dos.conf</em>:</p>
<div class="highlight"><pre><span></span><code>[Definition]

# Option: failregex
# Note: This regex will match any GET or POST entry in your logs, so basically
# all valid and not valid entries are a match.
# You should set up in the jail.conf file, the maxretry and findtime carefully
# in order to avoid false positives.

failregex = ^&lt;HOST&gt; -.*\&quot;(GET|POST).*

# Option: ignoreregex
# Notes.: regex to ignore. If this regex matches, the line is ignored.
# Values: TEXT
#

ignoreregex =
</code></pre></div>

<p>Now create <em>/etc/fail2ban/action.d/ban-countries.conf</em>:</p>
<div class="highlight"><pre><span></span><code># Copied from iptables-allports.conf
[Definition]

actionstart = &lt;iptables&gt; -N f2b-&lt;name&gt;
              &lt;iptables&gt; -A f2b-&lt;name&gt; -j &lt;returntype&gt;
              &lt;iptables&gt; -I &lt;chain&gt; -p &lt;protocol&gt; -j f2b-&lt;name&gt;

actionstop = &lt;iptables&gt; -D &lt;chain&gt; -p &lt;protocol&gt; -j f2b-&lt;name&gt;
             &lt;iptables&gt; -F f2b-&lt;name&gt;
             &lt;iptables&gt; -X f2b-&lt;name&gt;

actioncheck = &lt;iptables&gt; -n -L &lt;chain&gt; | grep -q &#39;f2b-&lt;name&gt;[ \t]&#39;

actionban = IP=&lt;ip&gt; &amp;&amp;
            COUNTRY=$(geoiplookup $IP | egrep &quot;&lt;country_list&gt;&quot;) &amp;&amp; [ &quot;$COUNTRY&quot; ] &amp;&amp;
            &lt;iptables&gt; -I f2b-&lt;name&gt; 1 -s &lt;ip&gt; -j &lt;blocktype&gt; || true

actionunban = true

[Init]

country_list = CN|China
</code></pre></div>

<p>Finally, <a href="https://docs.nextcloud.com/server/latest/admin_manual/installation/harden_server.html#setup-fail2ban">set up fail2ban to also protect you from attacks against Nextcloud</a>. The <code>logpath</code> to use is <code>/var/log/nextcloud/nextcloud.log</code>.</p>
<p>Now install missing packages, reload the service maually to make sure there is no error:</p>
<div class="highlight"><pre><span></span><code>su
apt install geoip-bin geoip-database
systemctl stop fail2ban
fail2ban-client -x start
less /var/log/fail2ban.log
<span class="c1"># Check for errors</span>
fail2ban-client -x stop
systemctl start fail2ban
</code></pre></div>

<h1 id="troubleshooting">Troubleshooting</h1>
<p>Should you have a <a href="https://www.youtube.com/watch?v=IGtzaIlMgWA">beeping hard disk drive</a>, the reason might be power consumption. It usually beeps when it needs more electricity. <a href="http://www.htpcguides.com/spin-down-and-manage-hard-drive-power-on-raspberry-pi/">Disabling Advanced Power Management</a> will solve this problem in most cases (<code>sudo hdparm -B 255 /dev/sda</code>).</p>
<h1 id="going-further">Going further</h1>
<h2 id="pro-tips">Pro tips</h2>
<p>Consider buying an <a href="https://www.modmypi.com/raspberry-pi/breakout-boards/pi-modules/ups-pico">uninterruptible power supply (UPS) for your Raspberry to prevent damage caused by power outage</a>.</p>
<h2 id="talk">Talk</h2>
<p>A year ago, I gave a talk at <a href="http://humantalks.com/cities/compiegne">HumanTalks Compiègne</a> about my Raspberry Pi. Here are the video and the slides.</p>
<iframe width="700" height="394" src="https://www.youtube-nocookie.com/embed/ECzGnX644yc?rel=0" frameborder="0" allowfullscreen></iframe>

<iframe width="700" height="600" src="https://romainpellerin.eu/slides/embedder.html#self-hosting/slides.html" allowfullscreen></iframe>

<p><a href="https://romainpellerin.eu/slides/self-hosting/slides.html">Slides are available in HTML</a>.</p>
<h2 id="interesting-external-links">Interesting external links</h2>
<ul>
<li><a href="http://www.minimachines.net/actu/piwall-creer-un-mur-decrans-low-cost-avec-des-raspberry-pi-28656">Piwall : Créer un mur d’écrans low cost avec des Raspberry Pi</a></li>
<li><a href="http://korben.info/raspberry-pi-allonger-la-duree-de-vie-de-vos-cartes-sd.html">Raspberry Pi – Allonger la durée de vie de vos cartes SD</a></li>
<li><a href="http://linuxfr.org/news/se-passer-de-dropbox-en-montant-son-coffre-fort-numerique-a-la-maison">Se passer de Dropbox en montant son coffre-fort numérique à la maison</a></li>
<li><a href="http://korben.info/idees-raspberry-pi.html">Plus de 50 idées pour votre Raspberry Pi</a></li>
<li><a href="http://www.24joursdeweb.fr/2014/piloter-sa-maison-grace-au-web/">Piloter sa maison grâce au web</a></li>
<li><a href="https://github.com/Banrai/PiScan">PiScan: A personal shopping and inventory-tracking device based on the Raspberry Pi</a></li>
<li><a href="https://www.raspberrypi.org/magpi-issues/Projects_Book_v1.pdf">THE Official RASPBERRY PI PROJECTS BOOK</a></li>
<li><a href="http://davidmaitland.me/2015/12/raspberry-pi-zero-headless-setup/">Raspberry Pi Zero Headless Setup</a></li>
<li><a href="http://hackaday.com/2016/06/28/raspberry-pi-gets-turned-on/">RASPBERRY PI GETS TURNED ON</a></li>
<li><a href="http://www.geek-directeur-technique.com/2016/07/19/installation-serveur-https-rapide">Installation serveur HTTP(S) rapide</a></li>
<li><a href="https://techcrunch.com/2016/11/16/the-r-pi-iot-shield-adds-iot-connectivity-to-your-diy-project/">The R.Pi IoT Shield adds IoT connectivity to your DIY project</a></li>
<li><a href="https://github.com/deepsyx/home-automation">Raspberry Pi 3 based home automation with NodeJS and React Native.</a></li>
<li><a href="https://bbrks.me/rpi-minidlna-media-server/">Using your Raspberry Pi as a DLNA/UPnP media server</a></li>
<li><a href="https://github.com/rpellerin/raspberry-pi-security-camera">raspberry-pi-security-camera</a></li>
<li><a href="https://mon-blog.jbriault.fr/index.php/blog/2019/02/06/s%C3%A9curiser-l-administration-de-son-vps">Protéger son VPS</a></li>
</ul>
<h3 id="read-only-raspberry-pi">Read-only Raspberry Pi</h3>
<ul>
<li><a href="http://david.mercereau.info/raspberrypi-raspbian-en-lecture-seul-readonly-pour-preserver-la-carte-sd/">RaspberryPi &amp; Raspbian en lecture seul (ReadOnly) pour préserver la carte SD</a></li>
<li><a href="http://tinycorelinux.net/ports.html">Tiny Core Linux</a></li>
</ul>
</article>
<footer class="grey italic small">
    Last update: Fri 01 January 2021</footer>

        </div> <!-- WRAPPER -->
    </body>
</html>