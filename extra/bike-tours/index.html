<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>A better Komoot</title>

    <!-- Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Custom Styles -->
    <style>
      /* Set the map container height */
      #map {
        height: 100%;
        width: 100%;
      }
      /* Make the GPX track itself clickable */
      .leaflet-interactive {
        cursor: pointer;
        transition: opacity 0.2s ease-in-out; /* Smooth transition for opacity change */
      }
      /* Style for the GPX track to create a white border effect */
      .gpx-track {
        filter: drop-shadow(1.5px 1.5px 0 #fff)
          drop-shadow(-1.5px -1.5px 0 #fff) drop-shadow(1.5px -1.5px 0 #fff)
          drop-shadow(-1.5px 1.5px 0 #fff);
      }
      /* Ensure JS-applied transform is smooth */
      #track-cards-container a {
        transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
      }
    </style>
  </head>
  <body class="overflow-hidden">
    <div class="flex flex-col md:flex-row h-screen font-sans">
      <!-- Left Column: Map -->
      <div class="w-full h-1/2 md:w-1/2 md:h-screen">
        <div id="map"></div>
      </div>

      <!-- Right Column: Tracks List -->
      <div
        class="w-full h-1/2 md:w-1/2 md:h-screen overflow-y-auto p-4 md:p-8 bg-gray-50"
      >
        <!-- Header -->
        <header class="text-center mb-4">
          <h1 class="text-3xl md:text-4xl font-bold text-gray-800">
            A better Komoot
          </h1>
          <p class="text-gray-600 mt-2">A collection of beautiful rides.</p>
        </header>

        <!-- Region Selector -->
        <div class="flex justify-center space-x-4 mb-6">
          <div>
            <input
              type="radio"
              id="berlin"
              name="region"
              value="berlin"
              class="hidden peer"
              checked
            />
            <label
              for="berlin"
              class="inline-flex items-center justify-between w-full px-4 py-2 text-gray-500 bg-white border-2 border-gray-200 rounded-lg cursor-pointer peer-checked:border-blue-600 peer-checked:text-blue-600 hover:text-gray-600 hover:bg-gray-100"
            >
              <div class="block">
                <div class="w-full text-lg font-semibold">Berlin</div>
              </div>
            </label>
          </div>
          <div>
            <input
              type="radio"
              id="allgaeu"
              name="region"
              value="allgaeu"
              class="hidden peer"
            />
            <label
              for="allgaeu"
              class="inline-flex items-center justify-between w-full px-4 py-2 text-gray-500 bg-white border-2 border-gray-200 rounded-lg cursor-pointer peer-checked:border-blue-600 peer-checked:text-blue-600 hover:text-gray-600 hover:bg-gray-100"
            >
              <div class="block">
                <div class="w-full text-lg font-semibold">Allg√§u</div>
              </div>
            </label>
          </div>
        </div>

        <!-- Toggle Switch -->
        <div class="flex items-center justify-end mb-6">
          <label for="map-toggle" class="mr-3 text-sm font-medium text-gray-900"
            >Show the maps</label
          >
          <label class="relative inline-flex items-center cursor-pointer">
            <input type="checkbox" id="map-toggle" class="sr-only peer" />
            <div
              class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"
            ></div>
          </label>
        </div>

        <!-- Track Cards Section -->
        <div>
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold text-gray-800">Available Rides</h2>
            <p id="file-info" class="text-sm text-gray-500 font-semibold">
              Loading tracks...
            </p>
          </div>
          <div
            id="track-cards-container"
            class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-1 xl:grid-cols-2 gap-6"
          >
            <!-- Track cards or skeleton loaders will be dynamically inserted here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Leaflet JS -->
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>

    <!-- Leaflet-GPX Plugin -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/gpx.min.js"></script>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // 1. Initialize the map and set its view
        const map = L.map("map").setView([52.52, 13.405], 9); // Initial view
        let gpxLayers = [];
        let allRideData = [];
        const rideDataCache = {}; // Cache for fetched ride data

        // 2. Add OpenStreetMap tile layer
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          attribution:
            '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        }).addTo(map);

        // 3. UI element references
        const fileInfo = document.getElementById("file-info");
        const trackCardsContainer = document.getElementById(
          "track-cards-container"
        );
        const mapToggle = document.getElementById("map-toggle");
        const regionRadios = document.querySelectorAll('input[name="region"]');

        // 4. Function to generate a random hex color with good contrast
        function getRandomColor() {
          // Using HSL color space to control brightness and saturation
          // Hue: 0-360 (any color)
          // Saturation: 70-100% (vivid colors)
          // Lightness: 30-60% (avoiding very dark or very bright colors)
          const h = Math.random();
          const s = 0.7 + Math.random() * 0.3;
          const l = 0.3 + Math.random() * 0.3;

          let r, g, b;

          if (s === 0) {
            r = g = b = l; // achromatic
          } else {
            const hue2rgb = (p, q, t) => {
              if (t < 0) t += 1;
              if (t > 1) t -= 1;
              if (t < 1 / 6) return p + (q - p) * 6 * t;
              if (t < 1 / 2) return q;
              if (t < 2 / 3) return p + (q - p) * (2 / 3 - t) * 6;
              return p;
            };

            const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
            const p = 2 * l - q;
            r = hue2rgb(p, q, h + 1 / 3);
            g = hue2rgb(p, q, h);
            b = hue2rgb(p, q, h - 1 / 3);
          }

          const toHex = (x) => {
            const hex = Math.round(x * 255).toString(16);
            return hex.length === 1 ? "0" + hex : hex;
          };

          return `#${toHex(r)}${toHex(g)}${toHex(b)}`;
        }

        // 5. Function to fit map bounds to all layers
        function fitMapToAllLayers() {
          if (gpxLayers.length === 0) return;
          const allBounds = new L.LatLngBounds();
          gpxLayers.forEach((layer) => allBounds.extend(layer.getBounds()));
          if (allBounds.isValid()) {
            map.fitBounds(allBounds, { padding: [50, 50] }); // Add padding
          }
        }

        // 6. Function to fetch Komoot image URLs with proxy fallback
        async function fetchKomootImageUrls(komootUrl) {
          const encodedUrl = encodeURIComponent(komootUrl);
          const proxies = [
            komootUrl,
            `https://corsproxy.io/?${encodedUrl}`,
            `https://api.codetabs.com/v1/proxy/?quest=${encodedUrl}`,
            `https://thingproxy.freeboard.io/fetch/${komootUrl}`,
            `https://cors.eu.org/${komootUrl}`,
          ];

          for (const proxyUrl of proxies) {
            try {
              const response = await fetch(proxyUrl);
              if (!response.ok) {
                console.warn(
                  `${proxyUrl} failed with status ${response.status}. Trying next...`
                );
                continue;
              }
              const text = await response.text();
              const doc = new DOMParser().parseFromString(text, "text/html");
              const metaTags = doc.querySelectorAll(
                'meta[property="og:image"]'
              );

              // If the proxy returns content but no images, it's not useful. Try the next one.
              if (metaTags.length === 0) {
                console.warn(
                  `${proxyUrl} returned content with no images. Trying next...`
                );
                continue;
              }

              let photoUrl = metaTags[0].getAttribute("content");
              let mapUrl = "https://placehold.co/600x400/eee/ccc?text=No+Map";

              const mapMeta = Array.from(metaTags).find((meta) =>
                meta
                  .getAttribute("content")
                  .startsWith("https://tourpic-vector.maps.komoot.net")
              );
              if (mapMeta) {
                mapUrl = mapMeta.getAttribute("content");
              }
              console.log(`Successfully fetched images using ${proxyUrl}`);
              return { photoUrl, mapUrl };
            } catch (error) {
              console.warn(
                `Proxy ${proxyUrl} threw an error. Trying next...`,
                error
              );
            }
          }

          console.error("Failed to fetch Komoot image for", komootUrl);
          return {
            photoUrl: "https://placehold.co/600x400/eee/ccc?text=Image+Error",
            mapUrl: "https://placehold.co/600x400/eee/ccc?text=Map+Error",
          };
        }

        // 7. Card Rendering and Updating Functions
        function renderInitialTrackCard(trackName, komootUrl, trackColor) {
          const cardLink = document.createElement("a");
          cardLink.href = komootUrl;
          cardLink.target = "_blank";
          cardLink.rel = "noopener noreferrer";
          cardLink.className =
            "block bg-white rounded-lg shadow-lg overflow-hidden transform group";

          cardLink.innerHTML = `
                <div class="image-container overflow-hidden">
                    <div class="w-full h-40 bg-gray-200 animate-pulse"></div>
                </div>
                <div class="p-4 border-t-4" style="border-color: ${trackColor};">
                    <h3 class="font-bold text-gray-800 text-base truncate">${trackName}</h3>
                </div>
            `;
          return cardLink;
        }

        function createAndAppendFullCard(data, showMaps) {
          const { trackName, komootUrl, photoUrl, mapUrl, trackColor } = data;
          const imageUrl = showMaps ? mapUrl : photoUrl;
          const cardLink = document.createElement("a");
          cardLink.href = komootUrl;
          cardLink.target = "_blank";
          cardLink.rel = "noopener noreferrer";
          cardLink.className =
            "block bg-white rounded-lg shadow-lg overflow-hidden transform group hover:scale-105 transition-transform duration-300";

          cardLink.innerHTML = `
                <div class="image-container overflow-hidden">
                    <img src="${imageUrl}" alt="Image for ${trackName}" class="w-full h-40 object-cover group-hover:scale-110 transition-transform duration-300" onerror="this.onerror=null;this.src='https.placehold.co/600x400/eee/ccc?text=Image+Error';">
                </div>
                <div class="p-4 border-t-4" style="border-color: ${trackColor};">
                    <h3 class="font-bold text-gray-800 text-base truncate">${trackName}</h3>
                </div>
            `;
          trackCardsContainer.appendChild(cardLink);
          return cardLink;
        }

        function updateCardWithImage(data, showMaps) {
          const { card, trackName, photoUrl, mapUrl } = data;
          const imageUrl = showMaps ? mapUrl : photoUrl;
          const imageContainer = card.querySelector(".image-container");

          card.classList.add(
            "hover:scale-105",
            "transition-transform",
            "duration-300"
          );
          imageContainer.innerHTML = `
                <img src="${imageUrl}" alt="Image for ${trackName}" class="w-full h-40 object-cover group-hover:scale-110 transition-transform duration-300" onerror="this.onerror=null;this.src='https.placehold.co/600x400/eee/ccc?text=Image+Error';">
            `;
        }

        function updateCardWithError(card) {
          const imageContainer = card.querySelector(".image-container");
          const titleContainer = card.querySelector(".p-4 h3");
          const borderContainer = card.querySelector(".p-4");

          imageContainer.innerHTML = `
                <div class="w-full h-40 bg-gray-200 flex items-center justify-center">
                    <p class="text-red-500 font-semibold">Failed to load</p>
                </div>
            `;
          titleContainer.classList.remove("text-gray-800");
          titleContainer.classList.add("text-gray-500");
          borderContainer.style.borderColor = "rgb(239 68 68)"; // red-500
          card.removeAttribute("href");
          card.classList.remove("hover:scale-105");
        }

        // 8. Main function to load rides for a given region
        async function loadRidesForRegion() {
          // General cleanup
          gpxLayers.forEach((layer) => map.removeLayer(layer));
          gpxLayers = [];
          allRideData = [];

          const selectedRegion = document.querySelector(
            'input[name="region"]:checked'
          ).value;

          // Check cache first
          if (rideDataCache[selectedRegion]) {
            console.log("Loading from cache:", selectedRegion);
            allRideData = rideDataCache[selectedRegion];
            trackCardsContainer.innerHTML = "";
            fileInfo.textContent = `Displaying ${allRideData.length} cached tracks.`;

            allRideData.forEach((data) => {
              const card = createAndAppendFullCard(data, mapToggle.checked);
              data.card = card; // re-assign DOM element
              data.layer.addTo(map);
              gpxLayers.push(data.layer);
              bindIndividualEvents(data);
            });

            fitMapToAllLayers();
            return;
          }

          // --- If not in cache, fetch and process ---

          fileInfo.textContent = "Loading tracks...";
          trackCardsContainer.innerHTML = "";

          const jsonPath = `${selectedRegion}_rides.json`;

          let rides = [];
          try {
            const response = await fetch(jsonPath);
            if (!response.ok)
              throw new Error(`HTTP error! status: ${response.status}`);
            rides = await response.json();
          } catch (e) {
            fileInfo.textContent = `Error loading ${jsonPath}`;
            console.error(`Could not load ${jsonPath}`, e);
            return;
          }

          if (rides.length === 0) {
            fileInfo.textContent = "No tracks to display for this region.";
            return;
          }

          fileInfo.textContent = `Loading ${rides.length} tracks...`;

          const dataPromises = rides.map((rideData) => processRide(rideData));

          const resolvedData = await Promise.all(dataPromises);
          rideDataCache[selectedRegion] = resolvedData.filter(Boolean);
          console.log("Region data cached:", selectedRegion);
          fileInfo.textContent = `Displaying ${allRideData.length} of ${rides.length} tracks.`;
        }

        // 9. Process a single ride (fetch, render, update)
        async function processRide(rideData) {
          const [gpxFile, trackName, komootUrl] = rideData;

          const data = {
            trackName,
            komootUrl,
            trackColor: getRandomColor(),
            card: null,
            layer: null,
            photoUrl: null,
            mapUrl: null,
            gpxData: null,
          };

          try {
            // Render initial card immediately
            data.card = renderInitialTrackCard(
              data.trackName,
              data.komootUrl,
              data.trackColor
            );
            trackCardsContainer.appendChild(data.card);

            // Fetch GPX data
            const gpxResponse = await fetch(gpxFile);
            if (!gpxResponse.ok)
              throw new Error(`GPX fetch failed for ${trackName}`);
            data.gpxData = await gpxResponse.text();

            // Create map layer
            data.layer = new L.GPX(data.gpxData, {
              async: true,
              marker_options: {
                startIconUrl: null,
                endIconUrl: null,
                shadowUrl: null,
              },
              polyline_options: {
                color: data.trackColor,
                weight: 5,
                opacity: 1,
                className: "gpx-track",
              },
            });

            // Add to global array and bind events
            allRideData.push(data);
            bindIndividualEvents(data);

            // Fetch image data in the background
            const imageUrls = await fetchKomootImageUrls(komootUrl);
            data.photoUrl = imageUrls.photoUrl;
            data.mapUrl = imageUrls.mapUrl;

            // Update the card with the image
            updateCardWithImage(data, mapToggle.checked);

            return data; // Return the fully populated data object for caching
          } catch (error) {
            console.error(`Failed to process ride: ${trackName}`, error);
            if (data.card) {
              updateCardWithError(data.card);
            }
            const index = allRideData.findIndex((d) => d === data);
            if (index > -1) {
              allRideData.splice(index, 1);
            }
            return null; // Indicate failure
          }
        }

        // 10. Function to bind events to a single card and map layer
        function bindIndividualEvents(data) {
          const { layer, card, trackName, komootUrl } = data;

          const highlight = () => {
            allRideData.forEach((d) => {
              if (d === data) {
                if (d.layer) d.layer.setStyle({ opacity: 1 }).bringToFront();
                d.card.classList.add("shadow-xl", "scale-105");
              } else {
                if (d.layer) d.layer.setStyle({ opacity: 0.2 });
                d.card.classList.remove("shadow-xl", "scale-105");
              }
            });
          };

          const unhighlightAll = () => {
            allRideData.forEach((d) => {
              if (d.layer) d.layer.setStyle({ opacity: 1 });
              d.card.classList.remove("shadow-xl", "scale-105");
            });
          };

          card.addEventListener("mouseenter", highlight);
          card.addEventListener("mouseleave", unhighlightAll);

          layer
            .on("loaded", (e) => {
              if (!gpxLayers.includes(layer)) gpxLayers.push(layer);
              e.target.bindTooltip(trackName, {
                sticky: true,
                className: "font-bold",
              });
              fitMapToAllLayers();
            })
            .on("click", () => window.open(komootUrl, "_blank"))
            .on("mouseover", highlight)
            .on("mouseout", unhighlightAll)
            .addTo(map);
        }

        // 11. Add listeners for UI controls
        regionRadios.forEach((radio) =>
          radio.addEventListener("change", loadRidesForRegion)
        );
        mapToggle.addEventListener("change", function () {
          const showMaps = this.checked;
          allRideData.forEach((data) => {
            if (data.mapUrl && data.photoUrl) {
              const imgElement = data.card.querySelector("img");
              if (imgElement) {
                imgElement.src = showMaps ? data.mapUrl : data.photoUrl;
              }
            }
          });
        });

        // 12. Initial Load
        loadRidesForRegion();
      });
    </script>
  </body>
</html>
